## Summary:  
Software: moodle  
## Fix:  
Commit: https://github.com/moodle/moodle/commit/914499a340dcdeffc9336eb5fa080d5dc51e6bac  
Change Size: +167 -2  
Author: Petr Skoda  
Fix Time (of the Last Commit): 2013-12-27  
Fix Pattern: Sanitization -> Redaction -> Introduction -> NoNeedToDetermineSensitiveData -> NoRedactionFunctionDefined  
Fixing-commits Count: 1  
Total Change Size: +167 -2  
## Sample logs: No  
## Logging statements:  
### Source labels:  
Type of Sensitive Information:authentication data -> passwords  
### Sink labels:  
#### Sink 1:  
Logging call Function:  User-defined（add_to_config_log）  
Sensitiveness-Identifiable Source:  Same Projects & Cross Modules（https://github.com/moodle/moodle/blob/b8b50d04feb98b8758abe8589740b2f273982d9a/admin/settings/server.php#L103） -> String Literals（proxypassword）  
Programming Language:PHP  
```PHP  
  
// https://github.com/moodle/moodle/blob/b8b50d04feb98b8758abe8589740b2f273982d9a/admin/settings/server.php#L103  
$temp->add(new admin_setting_configpasswordunmask('proxypassword', new lang_string('proxypassword', 'admin'), new lang_string('configproxypassword', 'admin'), ''));  
  
  
// https://github.com/moodle/moodle/blob/b8b50d04feb98b8758abe8589740b2f273982d9a/admin/settings.php#L36-L52  
if ($data = data_submitted() and confirm_sesskey()) {  
    if (admin_write_settings($data)) {  
        $statusmsg = get_string('changessaved');  
    }  
  
    if (empty($adminroot->errors)) {  
        switch ($return) {  
            case 'site': redirect("$CFG->wwwroot/");  
            case 'admin': redirect("$CFG->wwwroot/$CFG->admin/");  
        }  
    } else {  
        $errormsg = get_string('errorwithsettings', 'admin');  
        $firsterror = reset($adminroot->errors);  
    }  
    $adminroot = admin_get_root(true); //reload tree  
    $settingspage = $adminroot->locate($section, true);  
}  
  
// https://github.com/moodle/moodle/blob/b8b50d04feb98b8758abe8589740b2f273982d9a/lib/weblib.php#L802-L822  
/**  
 * Determine if there is data waiting to be processed from a form  
 *  
 * Used on most forms in Moodle to check for data  
 * Returns the data as an object, if it's found.  
 * This object can be used in foreach loops without  
 * casting because it's cast to (array) automatically  
 *  
 * Checks that submitted POST data exists and returns it as object.  
 *  
 * @uses $_POST  
 * @return mixed false or object  
 */  
function data_submitted() {  
  
    if (empty($_POST)) {  
        return false;  
    } else {  
        return (object)fix_utf8($_POST);  
    }  
}  
  
  
// https://github.com/moodle/moodle/blob/b8b50d04feb98b8758abe8589740b2f273982d9a/lib/adminlib.php#L1803-L1895  
/**  
 * The most flexibly setting, user is typing text  
 *  
 * @license http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later  
 */  
class admin_setting_configtext extends admin_setting {  
  
    /** @var mixed int means PARAM_XXX type, string is a allowed format in regex */  
    public $paramtype;  
    /** @var int default field size */  
    public $size;  
  
    /**  
     * Config text constructor  
     *  
     * @param string $name unique ascii name, either 'mysetting' for settings that in config, or 'myplugin/mysetting' for ones in config_plugins.  
     * @param string $visiblename localised  
     * @param string $description long localised info  
     * @param string $defaultsetting  
     * @param mixed $paramtype int means PARAM_XXX type, string is a allowed format in regex  
     * @param int $size default field size  
     */  
    public function __construct($name, $visiblename, $description, $defaultsetting, $paramtype=PARAM_RAW, $size=null) {  
        $this->paramtype = $paramtype;  
        if (!is_null($size)) {  
            $this->size  = $size;  
        } else {  
            $this->size  = ($paramtype === PARAM_INT) ? 5 : 30;  
        }  
        parent::__construct($name, $visiblename, $description, $defaultsetting);  
    }  
  
    /**  
     * Return the setting  
     *  
     * @return mixed returns config if successful else null  
     */  
    public function get_setting() {  
        return $this->config_read($this->name);  
    }  
  
    public function write_setting($data) {  
        if ($this->paramtype === PARAM_INT and $data === '') {  
        // do not complain if '' used instead of 0  
            $data = 0;  
        }  
        // $data is a string  
        $validated = $this->validate($data);  
        if ($validated !== true) {  
            return $validated;  
        }  
        return ($this->config_write($this->name, $data) ? '' : get_string('errorsetting', 'admin'));  
    }  
  
    /**  
     * Validate data before storage  
     * @param string data  
     * @return mixed true if ok string if error found  
     */  
    public function validate($data) {  
        // allow paramtype to be a custom regex if it is the form of /pattern/  
        if (preg_match('#^/.*/$#', $this->paramtype)) {  
            if (preg_match($this->paramtype, $data)) {  
                return true;  
            } else {  
                return get_string('validateerror', 'admin');  
            }  
  
        } else if ($this->paramtype === PARAM_RAW) {  
            return true;  
  
        } else {  
            $cleaned = clean_param($data, $this->paramtype);  
            if ("$data" === "$cleaned") { // implicit conversion to string is needed to do exact comparison  
                return true;  
            } else {  
                return get_string('validateerror', 'admin');  
            }  
        }  
    }  
  
    /**  
     * Return an XHTML string for the setting  
     * @return string Returns an XHTML string  
     */  
    public function output_html($data, $query='') {  
        $default = $this->get_defaultsetting();  
  
        return format_admin_setting($this, $this->visiblename,  
        '<div class="form-text defaultsnext"><input type="text" size="'.$this->size.'" id="'.$this->get_id().'" name="'.$this->get_full_name().'" value="'.s($data).'" /></div>',  
        $this->description, true, '', $default, $query);  
    }  
}  
  
  
// https://github.com/moodle/moodle/blob/b8b50d04feb98b8758abe8589740b2f273982d9a/lib/adminlib.php#L1990-L2053  
/**  
 * Password field, allows unmasking of password  
 *  
 * @license http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later  
 */  
class admin_setting_configpasswordunmask extends admin_setting_configtext {  
    /**  
     * Constructor  
     * @param string $name unique ascii name, either 'mysetting' for settings that in config, or 'myplugin/mysetting' for ones in config_plugins.  
     * @param string $visiblename localised  
     * @param string $description long localised info  
     * @param string $defaultsetting default password  
     */  
    public function __construct($name, $visiblename, $description, $defaultsetting) {  
        parent::__construct($name, $visiblename, $description, $defaultsetting, PARAM_RAW, 30);  
    }  
  
    /**  
     * Returns XHTML for the field  
     * Writes Javascript into the HTML below right before the last div  
     *  
     * @todo Make javascript available through newer methods if possible  
     * @param string $data Value for the field  
     * @param string $query Passed as final argument for format_admin_setting  
     * @return string XHTML field  
     */  
    public function output_html($data, $query='') {  
        $id = $this->get_id();  
        $unmask = get_string('unmaskpassword', 'form');  
        $unmaskjs = '<script type="text/javascript">  
//<![CDATA[  
var is_ie = (navigator.userAgent.toLowerCase().indexOf("msie") != -1);  
document.getElementById("'.$id.'").setAttribute("autocomplete", "off");  
var unmaskdiv = document.getElementById("'.$id.'unmaskdiv");  
var unmaskchb = document.createElement("input");  
unmaskchb.setAttribute("type", "checkbox");  
unmaskchb.setAttribute("id", "'.$id.'unmask");  
unmaskchb.onchange = function() {unmaskPassword("'.$id.'");};  
unmaskdiv.appendChild(unmaskchb);  
var unmasklbl = document.createElement("label");  
unmasklbl.innerHTML = "'.addslashes_js($unmask).'";  
if (is_ie) {  
  unmasklbl.setAttribute("htmlFor", "'.$id.'unmask");  
} else {  
  unmasklbl.setAttribute("for", "'.$id.'unmask");  
}  
unmaskdiv.appendChild(unmasklbl);  
if (is_ie) {  
  // ugly hack to work around the famous onchange IE bug  
  unmaskchb.onclick = function() {this.blur();};  
  unmaskdiv.onclick = function() {this.blur();};  
}  
//]]>  
</script>';  
        return format_admin_setting($this, $this->visiblename,  
        '<div class="form-password"><input type="password" size="'.$this->size.'" id="'.$id.'" name="'.$this->get_full_name().'" value="'.s($data).'" /><div class="unmask" id="'.$id.'unmaskdiv"></div>'.$unmaskjs.'</div>',  
        $this->description, true, '', NULL, $query);  
    }  
}  
  
  
// https://github.com/moodle/moodle/blob/b8b50d04feb98b8758abe8589740b2f273982d9a/lib/adminlib.php#L1598-L1633  
  
    /**  
     * Used to set a config pair and log change  
     *  
     * @param string $name  
     * @param mixed $value Gets converted to string if not null  
     * @return bool Write setting to config table  
     */  
    public function config_write($name, $value) {  
        global $DB, $USER, $CFG;  
  
        if ($this->nosave) {  
            return true;  
        }  
  
        // make sure it is a real change  
        $oldvalue = get_config($this->plugin, $name);  
        $oldvalue = ($oldvalue === false) ? null : $oldvalue; // normalise  
        $value = is_null($value) ? null : (string)$value;  
  
        if ($oldvalue === $value) {  
            return true;  
        }  
  
        // store change  
        set_config($name, $value, $this->plugin);  
  
        // Some admin settings affect course modinfo  
        if ($this->affectsmodinfo) {  
            // Clear course cache for all courses  
            rebuild_course_cache(0, true);  
        }  
  
        add_to_config_log($name, $oldvalue, $value, $this->plugin); // HERE IS THE SINK 1  
  
        return true; // BC only  
    }  
  
  
  
// https://github.com/moodle/moodle/blob/b8b50d04feb98b8758abe8589740b2f273982d9a/lib/datalib.php#L1517-L1545  
  
/**  
 * Add an entry to the config log table.  
 *  
 * These are "action" focussed rather than web server hits,  
 * and provide a way to easily reconstruct changes to Moodle configuration.  
 *  
 * @package core  
 * @category log  
 * @global moodle_database $DB  
 * @global stdClass $USER  
 * @param    string  $name     The name of the configuration change action  
                               For example 'filter_active' when activating or deactivating a filter  
 * @param    string  $oldvalue The config setting's previous value  
 * @param    string  $value    The config setting's new value  
 * @param    string  $plugin   Plugin name, for example a filter name when changing filter configuration  
 * @return void  
 */  
function add_to_config_log($name, $oldvalue, $value, $plugin) {  
    global $USER, $DB;  
  
    $log = new stdClass();  
    $log->userid       = during_initial_install() ? 0 :$USER->id; // 0 as user id during install  
    $log->timemodified = time();  
    $log->name         = $name;  
    $log->oldvalue  = $oldvalue;  
    $log->value     = $value;  
    $log->plugin    = $plugin;  
    $DB->insert_record('config_log', $log); // HERE IS THE INNER SINK  
}  
  
  
```  
