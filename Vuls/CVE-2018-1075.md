## Summary:  
Software: ovirt/ovirt_engine  
## Fix:  
Commit: https://github.com/oVirt/ovirt-engine/commit/da93a3d9fa56c111aa3b5d30e1e14a4d432ef29d  
Change Size: +7 -0  
Author: Yedidyah Bar David  
Fix Time (of the Last Commit): 2018-05-28  
Fix Pattern: Sanitization -> Redaction -> Enhancement (Corrective Change) -> Tag/TypeBasedFiltration  
  
Fixing-commits Count: 1  
Total Change Size: +7 0  
  
Review: https://gerrit.ovirt.org/#/c/91653/  
## Sample logs: No  
## Logging statements:  
### Source labels:  
Type of Sensitive Information:authentication data -> database passwords  
### Sink labels:  
#### Sink 1:  
Logging call Function:  Standard Libraries（logging）  
Sensitiveness-Identifiable Source:  Same Methods & Cross Statements（https://github.com/oVirt/ovirt-engine/blob/da93a3d9fa56c111aa3b5d30e1e14a4d432ef29d/packaging/setup/ovirt_engine_setup/engine_common/database.py#L1355） -> Variable Names（DEK.PASSWORD）|String Literals（password，finally outputed to logs）  
Programming Language:Python  
```Python  
# https://github.com/oVirt/ovirt-engine/blob/da93a3d9fa56c111aa3b5d30e1e14a4d432ef29d/packaging/setup/ovirt_engine_setup/engine_common/database.py#L1247-L1360  
  
        connectionValid = False  
        while not connectionValid:  
            dbenv = {}  
            for k in (  
                DEK.HOST,  
                DEK.PORT,  
                DEK.SECURED,  
                DEK.HOST_VALIDATION,  
                DEK.DATABASE,  
                DEK.USER,  
                DEK.PASSWORD,  
            ):  
                dbenv[self._dbenvkeys[k]] = _ind_env(self, k)  
  
            def query_dbenv(  
                what,  
                note,  
                tests=None,  
                **kwargs  
            ):  
                dialog.queryEnvKey(  
                    name='{qpref}{what}'.format(  
                        qpref=queryprefix,  
                        what=string.upper(what),  
                    ),  
                    dialog=self.dialog,  
                    logger=self.logger,  
                    env=dbenv,  
                    key=self._dbenvkeys[what],  
                    note=note.format(  
                        name=name,  
                    ),  
                    prompt=True,  
                    default=defaultdbenvkeys[what],  
                    tests=tests,  
                    **kwargs  
                )  
                if kwargs.get('hidden'):  
                    self.environment[  
                        otopicons.CoreEnv.LOG_FILTER  
                    ].append(  
                        dbenv[self._dbenvkeys[what]]  
                    )  
  
            query_dbenv(  
                what=DEK.HOST,  
                note=_('{name} database host [@DEFAULT@]: '),  
                tests=(  
                    {  
                        'test': osetuphostname.Hostname(  
                            self._plugin,  
                        ).getHostnameTester(),  
                    },  
                ),  
            )  
  
            query_dbenv(  
                what=DEK.PORT,  
                note=_('{name} database port [@DEFAULT@]: '),  
                tests=({'test': osetuputil.getPortTester()},),  
            )  
  
            if dbenv[self._dbenvkeys[DEK.SECURED]] is None:  
                dbenv[self._dbenvkeys[DEK.SECURED]] = dialog.queryBoolean(  
                    dialog=self.dialog,  
                    name='{qpref}SECURED'.format(qpref=queryprefix),  
                    note=_(  
                        '{name} database secured connection (@VALUES@) '  
                        '[@DEFAULT@]: '  
                    ).format(  
                        name=name,  
                    ),  
                    prompt=True,  
                    default=defaultdbenvkeys[DEK.SECURED],  
                )  
  
            if not dbenv[self._dbenvkeys[DEK.SECURED]]:  
                dbenv[self._dbenvkeys[DEK.HOST_VALIDATION]] = False  
  
            if dbenv[self._dbenvkeys[DEK.HOST_VALIDATION]] is None:  
                dbenv[  
                    self._dbenvkeys[DEK.HOST_VALIDATION]  
                ] = dialog.queryBoolean(  
                    dialog=self.dialog,  
                    name='{qpref}SECURED_HOST_VALIDATION'.format(  
                        qpref=queryprefix  
                    ),  
                    note=_(  
                        '{name} database host name validation in secured '  
                        'connection (@VALUES@) [@DEFAULT@]: '  
                    ).format(  
                        name=name,  
                    ),  
                    prompt=True,  
                    default=True,  
                ) == 'yes'  
  
            query_dbenv(  
                what=DEK.DATABASE,  
                note=_('{name} database name [@DEFAULT@]: '),  
            )  
  
            query_dbenv(  
                what=DEK.USER,  
                note=_('{name} database user [@DEFAULT@]: '),  
            )  
  
            query_dbenv(  
                what=DEK.PASSWORD,  
                note=_('{name} database password: '),  
                hidden=True,  
            ) # HERE IS THE FLOW  
  
            self.logger.debug('dbenv: %s', dbenv) # HERE IS THE SINK 1  
  
  
# https://github.com/oVirt/ovirt-setup-lib/blob/master/src/ovirt_setup_lib/dialog.py#L58-L169  
  
@util.export  
def queryEnvKey(  
    dialog,  
    logger,  
    env,  
    key,  
    note,  
    tests=None,  
    validValues=None,  
    caseSensitive=True,  
    hidden=False,  
    prompt=False,  
    default=None,  
    name=None,  
    store=True,  
    max_attempts=1000,  
):  
    """Query string and validate it.  
    Params:  
        dialog - plugin.dialog  
        logger - plugin.logger  
        env - a dict to store result into, usually plugin.environment  
        key - key in env to store result into  
            if env[key] is set, do not query  
        note - prompt to be displayed to the user  
        tests - tests to run on the input value  
        store - Store the value in environment  
    tests is a list of dicts, each having:  
        'test' -- Accepts a value and returns an error message if bad  
        'is_error' -- True (default) if a failure is an error, else a warning  
            If True and a test failed, ask user again. Otherwise prompt user  
            to accept value anyway.  
        'warn_note' -- Message displayed if warning  
        'warn_name' -- warn dialog name  
        'interactive_only' -- Do not run test if env[key] is already set  
        'default' -- Default value for warn_note message  
    """  
  
    logger.debug(  
        'queryEnvKey called for key {key}'.format(  
            key=key,  
        )  
    )  
    interactive = key not in env or env[key] is None  
    valid = False  
    attempts = 0  
    while not valid and attempts < max_attempts:  
        if interactive:  
            value = dialog.queryString(  
                name=(  
                    'queryEnvKey_input_{key}'.format(key=key)  
                    if name is None  
                    else name  
                ),  
                note=note,  
                validValues=validValues,  
                caseSensitive=caseSensitive,  
                hidden=hidden,  
                prompt=prompt,  
                default=default,  
            )  
        else:  
            value = env[key]  
        valid = True  
        for test in tests if tests else ():  
            if not interactive and test.get('interactive_only', False):  
                continue  
            msg = test['test'](value)  
            if msg:  
                if interactive:  
                    if test.get('is_error', True):  
                        logger.error(msg)  
                        valid = False  
                        attempts += 1  
                        break  
                    else:  
                        logger.warning(msg)  
                        valid = False  
                        proceed = dialog.queryString(  
                            name=(  
                                'queryEnvKey_warnverify_{key}'.format(  
                                    key=key  
                                ) if test.get('warn_name') is None  
                                else test['warn_name']  
                            ),  
                            note='{msg} (@VALUES@) [@DEFAULT@]: '.format(  
                                msg=test.get('warn_note', _('OK? ')),  
                            ),  
                            prompt=True,  
                            caseSensitive=False,  
                            validValues=(_('Yes'), _('No'), _('Abort')),  
                            default=test.get('default', _('No')),  
                        )  
                        if proceed.upper() == _('Yes').upper():  
                            valid = True  
                            break  
                        elif proceed.upper() == _('Abort').upper():  
                            raise RuntimeError(_('Aborted by user'))  
                        attempts += 1  
                        break  
                else:  # Not interactive  
                    if test.get('is_error', True):  
                        logger.error(msg)  
                        raise RuntimeError(msg)  
                    else:  
                        logger.warning(msg)  
    if attempts >= max_attempts:  
        raise RuntimeError('Maximum retry count has been reached')  
    if store:  
        env[key] = value  
    return value  
  
  
# https://github.com/oVirt/otopi/blob/775c2c54368a9f0f7f95552471b3d8b98a1c42a5/src/otopi/dialog.py#L29-L70  
  
@util.export  
class DialogBase(object):  
    """Base class for dialog.  
    Base class for all dialog providers.  
    """  
    def note(self, text, prompt=False):  
        """Print human readable note.  
        Keyword arguments:  
        text -- text to print, may be either list of lines or string.  
        prompt -- do not echo new line after note if possible.  
        Human readbale note is ignored by manager.  
        """  
        pass  
  
    def queryString(  
        self,  
        name,  
        note=None,  
        validValues=None,  
        caseSensitive=True,  
        hidden=False,  
        prompt=False,  
        default=None,  
    ):  
        """Query string from manager.  
        Keyword arguments:  
        name -- name of variable.  
        note -- note to present.  
        validValues -- tuple of valid values.  
        caseSensitive -- consider validValues as such.  
        hidden -- if tty echo will be disabled.  
        prompt -- do not echo new line after note if possible.  
        default -- if not None use this if empty.  
        """  
        raise NotImplementedError(_('Dialog queryString not implemented'))  
  
# https://github.com/oVirt/otopi/blob/775c2c54368a9f0f7f95552471b3d8b98a1c42a5/src/plugins/otopi/dialog/human.py#L225  
  
    def queryString(  
        self,  
        name,  
        note=None,  
        validValues=None,  
        caseSensitive=True,  
        hidden=False,  
        prompt=False,  
        default=None,  
    ):  
        self.logger.debug('query %s', name)  
        if default is not None:  
            default = common.toStr(default)  
        if validValues is not None:  
            validValues = [common.toStr(v) for v in validValues]  
        note = self._queryStringNote(  
            name=name,  
            note=note,  
            validValues=validValues,  
            default=default,  
        )  
  
        if not caseSensitive and validValues is not None:  
            validValues = [v.lower() for v in validValues]  
  
        accepted = False  
  
        if (  
            self.environment[constants.DialogEnv.AUTO_ACCEPT_DEFAULT] and  
            default is not None  
        ):  
            tempval = default if caseSensitive else default.lower()  
            if (  
                validValues is None or  
                tempval in validValues  
            ):  
                self.dialog.note(text=note, prompt=False)  
                value = tempval  
                accepted = True  
  
        occurrence = self._question_occurrences.get(name, 1)  
        envkey = '{prefix}{occurrence}/{name}'.format(  
            prefix=constants.CoreEnv.QUESTION_PREFIX,  
            occurrence=str(occurrence),  
            name=name,  
        )  
        self._question_occurrences[name] = occurrence+1  
        if envkey in self.environment:  
            answer = self.environment[envkey]  
            self.dialog.note(text=note, prompt=False)  
            self.dialog.note(  
                _(  
                    'provided answer: {answer}'  
                ).format(  
                    answer=_('(hidden)') if hidden else answer,  
                )  
            )  
            value = answer  
            accepted = True  
  
        while not accepted:  
            self.dialog.note(text=note, prompt=prompt)  
            value = self._readline(hidden=hidden)  
            if not value and default is not None:  
                value = default  
            if not caseSensitive:  
                value = value.lower()  
            if validValues is not None and value not in validValues:  
                self.logger.error(_('Invalid value'))  
            elif not value and value != default:  
                self.logger.error(_('Please specify value'))  
            else:  
                accepted = True  
  
        self.environment[envkey] = value  
        if hidden:  
            self.environment[constants.CoreEnv.LOG_FILTER].append(value) # Added in https://github.com/oVirt/otopi/commit/4abdab523b048c7b40f3d7ab7ff9773114e3c93f  
        return value  
  
```  
