## Summary:  
Software: cloud_foundry/garden-runc-release  
## Fix:  
Commit: https://github.com/cloudfoundry/garden-shed/commit/f1f0056896d239023ab56e3fcb6e96928c6d1b9d  
Author: Danail Branekov  
Fix Time (of the Last Commit): 2018-01-06  
Fix Pattern: Sanitization -> Filtration  
  
  
Fixing-commits Count: 2  
Total Change Size: +6 -8  
  
========  
Commit: https://github.com/cloudfoundry/garden-shed/commit/f1f0056896d239023ab56e3fcb6e96928c6d1b9d  
Change Size: +2 -2  
Commit: https://github.com/cloudfoundry/guardian/commit/e7e9e7e5e5a4fc68e5034d637f57c32c37481843  
Change Size: +4 -6  
## Sample logs: Yes  
```  
{"timestamp":"2018-10-08T10:59:26.124065350Z","level":"error","source":"guardian","message":"guardian.create.volume-creator.image-plugin-create.image-plugin-result","data":{"action":"create","error":"exit status 1","handle":"b0bd421b-8d9d-47af-6607-c0ed","session":"11295.2.1","spec":{"RootFS":{"Scheme":"docker","Opaque":"","User":null,"Host":"","Path":"/ytnobody/mecab-psgi","RawPath":"","ForceQuery":false,"RawQuery":"","Fragment":"latest"},"Namespaced":true,"QuotaSize":1073741824,"QuotaScope":0},"stdout":"pulling the image: streaming blob `sha256:57c84b889d81cbc20d0538e4e18a16e860ca1487cb3a9c8df53c4eb5aba6dfd5`: writing blob to tempfile: read tcp 10.10.148.22:36060-\u003e52.216.1.224:443: read: connection reset by peer\n"}}  
```  
## Logging statements:  
### Source labels:  
Type of Sensitive Information:authentication data -> credentials  
### Sink labels:  
#### Sink 1:  
Logging call Function:  Third-party Libaries（CloudFoundry lager）  
Sensitiveness-Identifiable Source:  Cross Projects|Cross-Library（https://github.com/cloudfoundry-attic/garden-shed/blob/f1f0056896d239023ab56e3fcb6e96928c6d1b9d/rootfs_spec/rootfs_spec.go#L12） -> Variable Names（Password）  
#### Sink 2:  
Logging call Function:  Third-party Libaries（CloudFoundry lager）  
Sensitiveness-Identifiable Source:  Cross Projects|Cross-Library（https://github.com/cloudfoundry-attic/garden-shed/blob/f1f0056896d239023ab56e3fcb6e96928c6d1b9d/rootfs_spec/rootfs_spec.go#L12） -> Variable Names（Password）  
#### Sink 3:  
Logging call Function:  Third-party Libaries（CloudFoundry lager）  
Sensitiveness-Identifiable Source:  Cross Projects|Cross-Library（https://github.com/cloudfoundry-attic/garden-shed/blob/f1f0056896d239023ab56e3fcb6e96928c6d1b9d/rootfs_spec/rootfs_spec.go#L12） -> Variable Names（Password）  
#### Sink 4:  
Logging call Function:  Third-party Libaries（CloudFoundry lager）  
Sensitiveness-Identifiable Source:  Cross Projects|Cross-Library（https://github.com/cloudfoundry-attic/garden-shed/blob/f1f0056896d239023ab56e3fcb6e96928c6d1b9d/rootfs_spec/rootfs_spec.go#L12） -> Variable Names（Password）  
#### Sink 5:  
Logging call Function:  Third-party Libaries（CloudFoundry lager）  
Sensitiveness-Identifiable Source:  Cross Projects|Cross-Library（https://github.com/cloudfoundry-attic/garden-shed/blob/f1f0056896d239023ab56e3fcb6e96928c6d1b9d/rootfs_spec/rootfs_spec.go#L12） -> Variable Names（Password）  
#### Sink 6:  
Logging call Function:  Third-party Libaries（CloudFoundry lager）  
Sensitiveness-Identifiable Source:  Cross Projects|Cross-Library（https://github.com/cloudfoundry-attic/garden-shed/blob/f1f0056896d239023ab56e3fcb6e96928c6d1b9d/rootfs_spec/rootfs_spec.go#L12） -> Variable Names（Password）  
Programming Language:Go  
```Go  
  
  
// https://github.com/cloudfoundry/lager/blob/55f178059589034528e56015a67dc6aa17d9675b/logger.go#L23-L30  
type logger struct {  
	component   string  
	task        string  
	sinks       []Sink  
	sessionID   string  
	nextSession uint32  
	data        Data  
}  
  
// https://github.com/cloudfoundry/lager/blob/55f178059589034528e56015a67dc6aa17d9675b/logger.go#L49-L67  
func (l *logger) Session(task string, data ...Data) Logger {  
	sid := atomic.AddUint32(&l.nextSession, 1)  
  
	var sessionIDstr string  
  
	if l.sessionID != "" {  
		sessionIDstr = fmt.Sprintf("%s.%d", l.sessionID, sid)  
	} else {  
		sessionIDstr = fmt.Sprintf("%d", sid)  
	}  
  
	return &logger{  
		component: l.component,  
		task:      fmt.Sprintf("%s.%s", l.task, task),  
		sinks:     l.sinks,  
		sessionID: sessionIDstr,  
		data:      l.baseData(data...),  
	}  
}  
  
// https://github.com/cloudfoundry/lager/blob/55f178059589034528e56015a67dc6aa17d9675b/logger.go#L79-L93  
func (l *logger) Debug(action string, data ...Data) {  
	t := time.Now().UTC()  
	log := LogFormat{  
		time:      t,  
		Timestamp: formatTimestamp(t),  
		Source:    l.component,  
		Message:   fmt.Sprintf("%s.%s", l.task, action),  
		LogLevel:  DEBUG,  
		Data:      l.baseData(data...),  
	}  
  
	for _, sink := range l.sinks {  
		sink.Log(log)  
	}  
}  
  
// https://github.com/cloudfoundry/lager/blob/55f178059589034528e56015a67dc6aa17d9675b/logger.go#L165-L185  
func (l *logger) baseData(givenData ...Data) Data {  
	data := Data{}  
  
	for k, v := range l.data {  
		data[k] = v  
	}  
  
	if len(givenData) > 0 {  
		for _, dataArg := range givenData {  
			for key, val := range dataArg {  
				data[key] = val  
			}  
		}  
	}  
  
	if l.sessionID != "" {  
		data["session"] = l.sessionID  
	}  
  
	return data  
}  
  
  
// https://github.com/cloudfoundry/lager/blob/55f178059589034528e56015a67dc6aa17d9675b/writer_sink.go#L29-L40  
func (sink *writerSink) Log(log LogFormat) {  
	if log.LogLevel < sink.minLogLevel {  
		return  
	}  
  
	// Convert to json outside of critical section to minimize time spent holding lock  
	message := append(log.ToJSON(), '\n')  
  
	sink.writeL.Lock()  
	sink.writer.Write(message)  
	sink.writeL.Unlock()  
}  
  
// https://github.com/cloudfoundry/lager/blob/55f178059589034528e56015a67dc6aa17d9675b/models.go#L71-L81  
func (log LogFormat) ToJSON() []byte {  
	content, err := json.Marshal(log)  
	if err != nil {  
		log.Data = dataForJSONMarhallingError(err, log.Data)  
		content, err = json.Marshal(log)  
		if err != nil {  
			panic(err)  
		}  
	}  
	return content  
}  
  
  
```  
```Go  
// https://github.com/cloudfoundry/guardian/blob/b48a5e072ce3a7feabcbd93f31573abfeeba9c25/imageplugin/image_plugin.go#L43-L112  
  
func (p *ImagePlugin) Create(log lager.Logger, handle string, spec gardener.RootfsSpec) (specs.Spec, error) {  
	errs := func(err error, action string) (specs.Spec, error) {  
		return specs.Spec{}, errorwrapper.Wrap(err, action)  
	}  
  
	log = log.Session("image-plugin-create", lager.Data{"handle": handle, "spec": spec}) // HERE IS THE FLOW  
	log.Debug("start") // HERE IS THE SINK 1  
	defer log.Debug("end") // HERE IS THE SINK 2  
  
	if spec.RootFS.String() == "" {  
		var err error  
		spec.RootFS, err = url.Parse(p.DefaultRootfs)  
  
		if err != nil {  
			log.Error("parsing-default-rootfs-failed", err) // HERE IS THE SINK 3  
			return errs(err, "parsing default rootfs")  
		}  
	}  
  
	if strings.HasPrefix(spec.RootFS.String(), fmt.Sprintf("%s:", PreloadedPlusLayerScheme)) {  
		var err error  
		spec.RootFS, err = p.ImageSpecCreator.CreateImageSpec(spec.RootFS, handle)  
		if err != nil {  
			log.Error("creating-image-spec", err) // HERE IS THE SINK 4  
			return errs(err, "creating image spec")  
		}  
	}  
  
	var (  
		createCmd *exec.Cmd  
		err       error  
	)  
	if spec.Namespaced {  
		createCmd, err = p.UnprivilegedCommandCreator.CreateCommand(log, handle, spec)  
	} else {  
		createCmd, err = p.PrivilegedCommandCreator.CreateCommand(log, handle, spec)  
	}  
	if err != nil {  
		return errs(err, "creating create command")  
	}  
  
	stdoutBuffer := bytes.NewBuffer([]byte{})  
	createCmd.Stdout = stdoutBuffer  
	createCmd.Stderr = NewRelogger(log)  
  
	if err := p.CommandRunner.Run(createCmd); err != nil {  
		logData := lager.Data{"action": "create", "stdout": stdoutBuffer.String()}  
		log.Error("image-plugin-result", err, logData) // HERE IS THE SINK 5  
		return errs(err, fmt.Sprintf("running image plugin create: %s", stdoutBuffer.String()))  
	}  
  
	var runtimeSpec specs.Spec  
	if err := json.Unmarshal(stdoutBuffer.Bytes(), &runtimeSpec); err != nil {  
		logData := lager.Data{"action": "create", "stdout": stdoutBuffer.String()}  
		log.Error("image-plugin-parsing", err, logData) // HERE IS THE SINK 6  
		return errs(err, fmt.Sprintf("parsing image plugin create: %s", stdoutBuffer.String()))  
	}  
  
	// Allow spec.Process.Env to be accessed without nil checks everywhere  
	if runtimeSpec.Process == nil {  
		runtimeSpec.Process = &specs.Process{}  
	}  
  
	// Allow spec.Root.Path to be accessed without nil checks everywhere  
	if runtimeSpec.Root == nil {  
		runtimeSpec.Root = &specs.Root{}  
	}  
  
	return runtimeSpec, nil  
}  
```  
