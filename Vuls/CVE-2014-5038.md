## Summary:  
Software: eucalyptus  
## Fix:  
Commit: https://github.com/eucalyptus/eucalyptus/commit/943d5ec2250e2573331d0cfc63a1f8c6d9ceaceb  
Author: Steve Jones  
Fix Time (of the Last Commit): 2014-09-30  
Fix Pattern: Disable Logging in Default (日志等级) | Remove -> Logging Calls  
  
  
Fixing-commits Count: 2  
Total Change Size: +24 -8  
  
========  
Commit: https://github.com/eucalyptus/eucalyptus/commit/06ee10da5d4db60b079e583f6ea1f6fcf8f633ca  
Change Size: +16 -8  
Author: Steve Jones  
Time: 2014-09-30  
Commit: https://github.com/eucalyptus/eucalyptus/commit/943d5ec2250e2573331d0cfc63a1f8c6d9ceaceb  
Change Size: +8 -0  
Author: Steve Jones  
Time: 2014-09-30  
## Sample logs: Yes  
```  
cloud-requests.log:Tue Sep 30 18:12:58 2014 1918023d-a845-4872-bfb7-1b204fd7e811 arn:aws:euare::135067858910:user/admin /10.111.5.45:37861 /10.111.5.45:8773 euare CreateLoginProfileType [POST,UserName=mike,Password=**********]  
cloud-requests.log:Tue Sep 30 18:13:50 2014 bbaaa44f-1c98-48e6-b60f-70fb06626f03 arn:aws:euare::135067858910:user/admin /10.111.5.45:37916 /10.111.5.45:8773 euare CreateLoginProfileType [POST,UserName=mike,Password=**********]  
  
```  
## Logging statements:  
### Source labels:  
Type of Sensitive Information:authentication data -> user and system passwords  
### Sink labels:  
#### Sink 1:  
Logging call Function:  Third-party Libaries（Apache Log4J）  
Sensitiveness-Identifiable Source:  跨方法-同文件（https://github.com/eucalyptus/eucalyptus/blob/39a6da3643ecb9890bda566299c1dd0d3446dc90/clc/modules/msgs/src/main/java/com/eucalyptus/auth/login/Hmacv2LoginModule.java#L40） -> Variable Names（credentials）  
#### Sink 2:  
Logging call Function:  Third-party Libaries（Apache Log4J）  
Sensitiveness-Identifiable Source:  Same Methods & Cross Statements（https://github.com/eucalyptus/eucalyptus/blob/101d85ff049bd81475f51c70984a69d12e667e43/clc/modules/msgs/src/main/java/com/eucalyptus/auth/login/Hmacv4LoginModule.java#L103） -> Variable Names（credentials）  
#### Sink 3:  
Logging call Function:  Third-party Libaries（Apache Log4J）  
Sensitiveness-Identifiable Source:  Same Projects & Cross Modules（https://github.com/eucalyptus/eucalyptus/blob/95e0cef57eba3da26ed798317900da4eeac44263/clc/modules/euare-common/src/main/java/com/eucalyptus/auth/euare/EuareMessages.groovy#L639）） -> Variable Names(password)  
#### Sink 4:  
Logging call Function:  Third-party Libaries（Apache Log4J）  
Sensitiveness-Identifiable Source:  Same Projects & Cross Modules（https://github.com/eucalyptus/eucalyptus/blob/95e0cef57eba3da26ed798317900da4eeac44263/clc/modules/euare-common/src/main/java/com/eucalyptus/auth/euare/EuareMessages.groovy#L639）） -> Variable Names(password)  
#### Sink 5:  
Logging call Function:  Third-party Libaries（Apache Commons Logging）  
Sensitiveness-Identifiable Source:  Cross Projects|Cross-Libraries（https://github.com/eucalyptus/eucalyptus/blob/95e0cef57eba3da26ed798317900da4eeac44263/clc/modules/euare-common/src/main/java/com/eucalyptus/auth/euare/EuareMessages.groovy#L639）） -> Variable Names(password)  
#### Sink 6:  
Logging call Function:  Third-party Libaries（Apache Commons Logging）  
Sensitiveness-Identifiable Source:  Cross Projects|Cross-Libraries（https://github.com/eucalyptus/eucalyptus/blob/95e0cef57eba3da26ed798317900da4eeac44263/clc/modules/euare-common/src/main/java/com/eucalyptus/auth/euare/EuareMessages.groovy#L639）） -> Variable Names(password)  
#### Sink 7:  
Logging call Function:  Third-party Libaries（Apache Commons Logging）  
Sensitiveness-Identifiable Source:  Cross Projects|Cross-Libraries（https://github.com/eucalyptus/eucalyptus/blob/95e0cef57eba3da26ed798317900da4eeac44263/clc/modules/euare-common/src/main/java/com/eucalyptus/auth/euare/EuareMessages.groovy#L639）） -> Variable Names(password)  
#### Sink 8:  
Logging call Function:  Third-party Libaries（Apache Commons Logging）  
Sensitiveness-Identifiable Source:  Cross Projects|Cross-Libraries（https://github.com/eucalyptus/eucalyptus/blob/95e0cef57eba3da26ed798317900da4eeac44263/clc/modules/euare-common/src/main/java/com/eucalyptus/auth/euare/EuareMessages.groovy#L639）） -> Variable Names(password)  
#### Sink 9:  
Logging call Function:  Third-party Libaries（Apache Commons Logging）  
Sensitiveness-Identifiable Source:  Cross Projects|Cross-Libraries（https://github.com/eucalyptus/eucalyptus/blob/95e0cef57eba3da26ed798317900da4eeac44263/clc/modules/euare-common/src/main/java/com/eucalyptus/auth/euare/EuareMessages.groovy#L639）） -> Variable Names(password)  
Programming Language:Java  
```Java  
  
// https://github.com/eucalyptus/eucalyptus/blob/39a6da3643ecb9890bda566299c1dd0d3446dc90/clc/modules/msgs/src/main/java/com/eucalyptus/auth/login/Hmacv2LoginModule.java#L67-L91  
  
  private String makeSubjectString( String httpMethod, String host, String path, final Map<String, String> parameters ) throws UnsupportedEncodingException {  
    URLCodec codec = new URLCodec();  
    parameters.remove("");  
    StringBuilder sb = new StringBuilder( );  
    sb.append( httpMethod );  
    sb.append( "\n" );  
    sb.append( host );  
    sb.append( "\n" );  
    sb.append( path );  
    sb.append( "\n" );  
    String prefix = sb.toString( );  
    sb = new StringBuilder( );  
    NavigableSet<String> sortedKeys = new TreeSet<String>( );  
    sortedKeys.addAll( parameters.keySet( ) );  
    String firstKey = sortedKeys.pollFirst( );  
    if( firstKey != null ) {   
      sb.append( codec.encode( firstKey ,"UTF-8" ) ).append( "=" ).append( codec.encode( parameters.get( firstKey ).replaceAll( "\\+", " " ), "UTF-8" ) );  
    }   
    while ( ( firstKey = sortedKeys.pollFirst( ) ) != null ) {  
      sb.append( "&" ).append( codec.encode( firstKey, "UTF-8" ) ).append( "=" ).append( codec.encode( parameters.get( firstKey ).replaceAll( "\\+", " " ), "UTF-8" ) );  
    }  
    String subject = prefix + sb.toString( );  
    LOG.trace( "VERSION2: " + subject ); // HERE IS THE SINK 1  
    return subject;  
  }  
  
// https://github.com/eucalyptus/eucalyptus/blob/39a6da3643ecb9890bda566299c1dd0d3446dc90/clc/modules/msgs/src/main/java/com/eucalyptus/auth/login/Hmacv2LoginModule.java#L31-L62  
  public boolean authenticate( HmacCredentials credentials ) throws Exception {  
    String sig = credentials.getSignature( );  
    SecurityContext.enqueueSignature( sig );  
    String secretKey;  
    try {  
      secretKey = CredentialProvider.getSecretKey( credentials.getQueryId( ) );  
    } catch ( Exception e ) {  
      return false;  
    }  
    String canonicalString = this.makeSubjectString( credentials.getVerb( ), credentials.getHeaderHost( ), credentials.getServicePath( ), credentials.getParameters( ) ); // HERE IS THE FLOW  
    String canonicalStringWithPort = this.makeSubjectString( credentials.getVerb( ), credentials.getHeaderHost( ) + ":" + credentials.getHeaderPort( ), credentials.getServicePath( ), credentials.getParameters( ) ); // HERE IS THE FLOW  
    String computedSig = this.getSignature( secretKey, canonicalString, credentials.getSignatureMethod( ) );  
    String computedSigWithPort = this.getSignature( secretKey, canonicalStringWithPort, credentials.getSignatureMethod( ) );  
    if ( !computedSig.equals( sig ) && !computedSigWithPort.equals( sig ) ) {  
      sig = URLDecoder.decode( sig ).replaceAll("=","");  
      computedSig = this.getSignature( secretKey, canonicalString.replaceAll("\\+","%2B"), credentials.getSignatureMethod( ) ).replaceAll("\\+"," ");  
      computedSigWithPort = this.getSignature( secretKey, canonicalStringWithPort.replaceAll("\\+","%2B"), credentials.getSignatureMethod( ) ).replaceAll("\\+"," ");  
      if( !computedSig.equals( sig ) && !computedSigWithPort.equals( sig ) ) {  
        computedSig = this.getSignature( secretKey, canonicalString.replaceAll("\\+","%20"), credentials.getSignatureMethod( ) ).replaceAll("\\+"," ");  
        computedSigWithPort = this.getSignature( secretKey, canonicalStringWithPort.replaceAll("\\+","%20"), credentials.getSignatureMethod( ) ).replaceAll("\\+"," ");  
        if( !computedSig.equals( sig ) && !computedSigWithPort.equals( sig ) ) {  
          return false;  
        }  
      }  
    }  
    String userName = CredentialProvider.getUserName( credentials.getQueryId( ) );  
    User user = CredentialProvider.getUser( userName );  
    super.setCredential( credentials.getQueryId( ) );  
    super.setPrincipal( user );  
    super.getGroups( ).addAll( Groups.getGroups( super.getPrincipal( ) ) );  
    return true;  
  }  
  
// https://github.com/eucalyptus/eucalyptus/blob/101d85ff049bd81475f51c70984a69d12e667e43/clc/modules/msgs/src/main/java/com/eucalyptus/auth/login/Hmacv4LoginModule.java#L93-L107  
  
  private String makeSubjectString( @Nonnull final HmacCredentials credentials,  
                                    @Nonnull final SignatureCredential signatureCredential,  
                                    @Nonnull final Map<String,String> authorizationParameters,  
                                    @Nonnull final Date date,  
                                    final boolean skipPath ) throws Exception {  
    final String timestamp = Timestamps.formatShortIso8601Timestamp( date );  
    final StringBuilder sb = new StringBuilder();  
    sb.append( SecurityHeader.Value.AWS4_HMAC_SHA256.value() ).append( "\n" );  
    sb.append( timestamp ).append( "\n" );  
    sb.append( signatureCredential.getCredentialScope() ).append("\n");  
    sb.append( digestUTF8( makeCanonicalRequest( credentials, authorizationParameters, skipPath ) ) );  
    final String subject = sb.toString( );  
    LOG.trace( "VERSION4: " + subject ); // HERE IS THE SINK 2  
    return subject;  
  }  
  
// https://github.com/eucalyptus/eucalyptus/blob/362b3a489a86faa4531984aba2f71923f181c8db/clc/modules/msgs/src/main/java/com/eucalyptus/ws/util/ErrorHandlerSupport.java#L58-L92  
  
  @SuppressWarnings("ThrowableResultOfMethodCallIgnored")  
  public void handle( final ExceptionMessage exMsg ) {  
    EventRecord.here( getClass(), EventType.MSG_REPLY, exMsg.getPayload().getClass().getSimpleName() ).debug();  
    LOG.trace( "Caught exception while servicing: " + exMsg.getPayload( ) ); // HERE IS THE SINK 3  
    final Throwable exception = exMsg.getException( );  
    if ( exception instanceof MessagingException && exception.getCause( ) instanceof EucalyptusCloudException ) {  
      try {  
        final EucalyptusCloudException cloudException = (EucalyptusCloudException) exception.getCause( );  
        final BaseMessage payload = parsePayload( ( ( MessagingException ) exception ).getUmoMessage( ).getPayload( ) );  
        final HttpResponseStatus status;  
        final Role role;  
        final String code;  
        if ( cloudException instanceof EucalyptusWebServiceException ) {  
          final EucalyptusWebServiceException webServiceException = (EucalyptusWebServiceException) cloudException;  
          role = webServiceException.getRole();  
          code = webServiceException.getCode();  
        } else {  
          role = Role.Receiver;  
          code = defaultCode;  
        }  
        final QueryBindingInfo info = Ats.inClassHierarchy( cloudException.getClass() ).get( QueryBindingInfo.class );  
        status = info == null ? HttpResponseStatus.INTERNAL_SERVER_ERROR : new HttpResponseStatus( info.statusCode(), code );  
        final BaseMessage errorResp = buildErrorResponse(   
            payload.getCorrelationId( ),  
            role,  
            code,  
            cloudException.getMessage()  
            );  
        Contexts.response( new BaseMessageSupplier( errorResp, status ) );  
      } catch ( final PayloadParseException e ) {  
        LOG.error( "Failed to parse payload ", e.getCause() );  
      }  
    } else {  
      LOG.error( "Unable to handle exception", exception );  
    }  
  }  
  
  
// https://github.com/eucalyptus/eucalyptus/blob/a6e82913e5ca0d20a51bd701a5e65b3d01c6b092/clc/modules/wsstack/src/main/java/com/eucalyptus/ws/util/EuareReplyQueue.java#L126-L152  
  
  public void handle( ExceptionMessage exMsg ) {  
    LOG.debug( "YE ---> handle 3: " + exMsg );  
    EventRecord.here( EuareReplyQueue.class, EventType.MSG_REPLY, exMsg.getPayload( ).getClass( ).getSimpleName( ) ).debug( );  
    LOG.trace( "Caught exception while servicing: " + exMsg.getPayload( ) ); // HERE IS THE SINK 4  
    Throwable exception = exMsg.getException( );  
    Object payload = null;  
    BaseMessage msg = null;  
    if ( exception instanceof MessagingException ) {  
      MessagingException ex = ( MessagingException ) exception;  
      MuleMessage muleMsg = ex.getUmoMessage( );  
  
      if ( payload instanceof VmAllocationInfo ) {  
        msg = ( ( VmAllocationInfo ) payload ).getRequest( );  
      } else {  
        try {  
          msg = parsePayload( muleMsg.getPayload( ) );  
        } catch ( Exception e ) {  
          LOG.error( "Bailing out of error handling: don't have the correlationId for the caller!" );  
          LOG.error( e, e );  
          return;  
        }  
      }  
      EucalyptusErrorMessageType errMsg = getErrorMessageType( exMsg.getComponentName( ), exMsg.getException( ), msg );  
      errMsg.setException( exception.getCause( ) );  
      this.handle( errMsg );  
    }  
  }  
  
  
// https://github.com/mulesoft/mule/blob/dc05b394e33f32747c9ac7207d9e1b96304f201c/core/src/main/java/org/mule/transformer/AbstractTransformer.java#L350-L410  
  
    public Object transform(Object src, String enc) throws TransformerException  
    {  
        Object payload = src;  
        if (src instanceof MuleMessage)  
        {  
            MuleMessage message = (MuleMessage) src;  
            if ((!isSourceDataTypeSupported(MULE_MESSAGE_DATA_TYPE, true) &&  
                 !(this instanceof AbstractMessageTransformer)))  
            {  
                src = ((MuleMessage) src).getPayload();  
                payload = message.getPayload();  
            }  
        }  
  
        DataType<?> sourceType = DataTypeFactory.create(payload.getClass());  
        //Once we support mime types, it should be possible to do this since we'll be able to discern the difference  
        //between objects with the same type  
//        if(getReturnDataType().isCompatibleWith(sourceType))  
//        {  
//            logger.debug("Object is already of type: " + getReturnDataType() + " No transform to perform");  
//            return payload;  
//        }  
  
        if (!isSourceDataTypeSupported(sourceType))  
        {  
            if (ignoreBadInput && !useExtendedTransformations())  
            {  
                logger.debug("Source type is incompatible with this transformer and property 'ignoreBadInput' is set to true, so the transformer chain will continue.");  
                return payload;  
            }  
            else  
            {  
                Message msg = CoreMessages.transformOnObjectUnsupportedTypeOfEndpoint(getName(),  
                    payload.getClass(), endpoint);  
                /// FIXME  
                throw new TransformerException(msg, this);  
            }  
        }  
  
        if (logger.isDebugEnabled())  
        {  
            logger.debug(String.format("Applying transformer %s (%s)", getName(), getClass().getName()));  
            logger.debug(String.format("Object before transform: %s", StringMessageUtils.toString(payload))); // HERE IS THE SINK 5  
        }  
  
        Object result = doTransform(payload, enc);  
  
        if (result == null)  
        {  
            result = NullPayload.getInstance();  
        }  
  
        if (logger.isDebugEnabled())  
        {  
            logger.debug(String.format("Object after transform: %s", StringMessageUtils.toString(result))); // HERE IS THE SINK 6  
        }  
  
        TransformerUtils.checkTransformerReturnClass(this, result);  
  
        return result;  
    }  
  
  
// https://github.com/mulesoft/mule/blob/dc05b394e33f32747c9ac7207d9e1b96304f201c/modules/client/src/main/java/org/mule/module/client/MuleClient.java#L291-L337  
  
    /**  
     * Sends an event synchronously to a component  
     *   
     * @param componentName the name of the Mule component to send to  
     * @param transformers a comma separated list of transformers to apply to the  
     *            result message  
     * @param message the message to send  
     * @return the result message if any of the invocation  
     * @throws org.mule.api.MuleException if the dispatch fails or the components or  
     *             transfromers cannot be found  
     */  
    public MuleMessage sendDirect(String componentName, String transformers, MuleMessage message)  
        throws MuleException  
    {  
        Service service = muleContext.getRegistry().lookupService(componentName);  
        if (service == null)  
        {  
            throw new ServiceException(CoreMessages.objectNotRegistered("Service", componentName));  
        }  
        List<Transformer> trans = null;  
        if (transformers != null)  
        {  
            trans = TransformerUtils.getTransformers(transformers, muleContext);  
        }  
  
        InboundEndpoint endpoint = getDefaultClientEndpoint(service, message.getPayload(), true);  
        MuleEvent event = new DefaultMuleEvent(message, endpoint, service);  
  
        if (logger.isDebugEnabled())  
        {  
            logger.debug("MuleClient sending event direct to: " + componentName + ". MuleEvent is: " + event); // HERE IS THE SINK 7  
        }  
  
        MuleEvent resultEvent = service.sendEvent(event);  
        MuleMessage result = resultEvent == null ? null : resultEvent.getMessage();  
        if (logger.isDebugEnabled())  
        {  
            logger.debug("Result of MuleClient sendDirect is: "  
                         + (result == null ? "null" : result.getPayload())); // HERE IS THE SINK 8  
        }  
  
        if (result != null && trans != null)  
        {  
            result.applyTransformers(resultEvent, trans);  
        }  
        return result;  
    }  
  
// https://github.com/mulesoft/mule/blob/dc05b394e33f32747c9ac7207d9e1b96304f201c/modules/client/src/main/java/org/mule/module/client/MuleClient.java#L354-L378  
  
    /**  
     * Dispatches an event asynchronously to a component  
     *   
     * @param componentName the name of the Mule components to dispatch to  
     * @param message the message to send  
     * @throws org.mule.api.MuleException if the dispatch fails or the components or  
     *             transfromers cannot be found  
     */  
    public void dispatchDirect(String componentName, MuleMessage message) throws MuleException  
    {  
        Service service = muleContext.getRegistry().lookupService(componentName);  
        if (service == null)  
        {  
            throw new ServiceException(CoreMessages.objectNotRegistered("Service", componentName));  
        }  
        InboundEndpoint endpoint = getDefaultClientEndpoint(service, message.getPayload(), false);  
        MuleEvent event = new DefaultMuleEvent(message, endpoint, service);  
  
        if (logger.isDebugEnabled())  
        {  
            logger.debug("MuleClient dispatching event direct to: " + componentName + ". MuleEvent is: " + event); // HERE IS THE SINK 9  
        }  
  
        service.dispatchEvent(event);  
    }  
  
```  
