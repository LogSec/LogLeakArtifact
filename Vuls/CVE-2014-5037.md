## Summary:  
Software: eucalyptus  
## Fix:  
Commit: https://github.com/eucalyptus/eucalyptus/commit/1efd1fa61a25697899ebc31c6801fba15b091330  
Author: Steve Jones  
Fix Time (of the Last Commit): 2014-09-20  
  
Fix Pattern: Sanitization -> Redaction -> Introduction -> TagBasedFiltration -> RedactionFunctionDefined  
  
Fixing-commits Count: 2  
Total Change Size: +358 -13  
  
========  
Commit: https://github.com/eucalyptus/eucalyptus/commit/e3ae88b1e6b370dde1182c85c699d8ff4cac4294  
Change Size: +356 -13  
Author: Steve Jones  
Time: 2014-09-07  
Comment: EUCA-9256，`RequestLoggingFilter`  
Pattern: Redaction -> Introduction -> KeywordBasedFiltration -> RedactionFunctionDefined  
  
Commit: https://github.com/eucalyptus/eucalyptus/commit/1efd1fa61a25697899ebc31c6801fba15b091330  
Change Size: +2 -0  
Author: Steve Jones  
Time: 2014-09-20  
Comment: EUCA-9987  
Pattern: Redaction -> Introduction -> TagBasedFiltration -> RedactionFunctionDefined  
## Sample logs: Yes  
```  
Fri Apr 25 12:59:50 2014 4a0cb0dc-de1c-43c9-875d-7da9d30315c5 arn:aws:euare::525566742355:user/admin /10.111.5.153:49314 /10.111.5.153:8773 euare CreateLoginProfileType <POST,UserName=admin,DelegateAccount=sjones,Password=password>  
```  
## Logging statements:  
### Source labels:  
Type of Sensitive Information:authentication data -> user and system passwords  
### Sink labels:  
#### Sink 1:  
Logging call Function:  User-defined（ServiceAccessLoggingHandler.createLogEntry）  
Sensitiveness-Identifiable Source:  Same Projects & Cross Modules（https://github.com/eucalyptus/eucalyptus/blob/95e0cef57eba3da26ed798317900da4eeac44263/clc/modules/euare-common/src/main/java/com/eucalyptus/auth/euare/EuareMessages.groovy#L639） -> Variable Names(password)  
#### Sink 2:  
Logging call Function:  User-defined（ServiceAccessLoggingHandler.createLogEntry）  
Sensitiveness-Identifiable Source:  Same Projects & Cross Modules（https://github.com/eucalyptus/eucalyptus/blob/95e0cef57eba3da26ed798317900da4eeac44263/clc/modules/euare-common/src/main/java/com/eucalyptus/auth/euare/EuareMessages.groovy#L639） -> Variable Names(password)  
#### Sink 3:  
Logging call Function:  User-defined（ServiceAccessLoggingHandler.createLogEntry）  
Sensitiveness-Identifiable Source:  Same Projects & Cross Modules（https://github.com/eucalyptus/eucalyptus/blob/95e0cef57eba3da26ed798317900da4eeac44263/clc/modules/euare-common/src/main/java/com/eucalyptus/auth/euare/EuareMessages.groovy#L639） -> Variable Names(password)  
Programming Language:Java  
```Java  
  
// https://github.com/eucalyptus/eucalyptus/blob/e3ae88b1e6b370dde1182c85c699d8ff4cac4294/clc/modules/msgs/src/main/java/com/eucalyptus/ws/server/ServiceAccessLoggingHandler.java#L163-L234  
  
  private static void createLogEntry( ChannelHandlerContext ctx, Object replyObject, String... extra ) {  
    try {  
      Context context = Contexts.lookup( ctx.getChannel( ) );  
      List<String> logEntries = Lists.newArrayList( context.getCorrelationId( ),  
                                                    context.getUserFullName( ).toString( ),  
                                                    ctx.getChannel( ).getRemoteAddress( ).toString( ),  
                                                    ctx.getChannel( ).getLocalAddress( ).toString( )  
                                     );  
      String componentName = "wsstack";//GRZE: this basically means unattributable to a component... sigh.  
      if ( replyObject instanceof BaseMessage ) {  
        try {  
          final Class<? extends ComponentId> compMsg = ComponentMessages.lookup( ( BaseMessage ) replyObject );  
          final ComponentId compId = ComponentIds.lookup( compMsg );  
          componentName = compId.name( );  
        } catch ( Exception e ) {  
          //GRZE: this needs to be a separate logger to avoid hitting the configured category for this class.  
          Logger.getLogger( "LoggingError." + ServiceAccessLoggingHandler.class.getCanonicalName( ) ).debug( e );  
        }  
      }  
      logEntries.add( componentName );  
      logEntries.add( replyObject.getClass( ).getSimpleName( ) );  
      logEntries.add( "[" + Joiner.on( "," ).join( Arrays.asList( extra ) ) + "]" );  
      LOG.info( Joiner.on( " " ).join( logEntries ) ); // HERE IS THE INNER SINK  
    } catch ( Exception e ) {  
      //GRZE: this needs to be a separate logger to avoid hitting the configured category for this class.  
      Logger.getLogger( "LoggingError." + ServiceAccessLoggingHandler.class.getCanonicalName( ) ).debug( e );  
    }  
  }  
    
  @Override  
  public void handleUpstream( ChannelHandlerContext ctx, ChannelEvent e ) throws Exception {  
    if ( firstNonNull( StackConfiguration.LOG_REQUESTS, Boolean.TRUE ) ) try {  
      if ( e instanceof MessageEvent ) {  
        final MessageEvent msge = ( MessageEvent ) e;  
        if ( msge.getMessage( ) instanceof MappingHttpRequest ) {// Handle single request-response MEP  
          MappingHttpRequest httpMessage = ( MappingHttpRequest ) ( ( MessageEvent ) e ).getMessage( );  
          final String method = Objects.toString( httpMessage.getMethod( ), "HTTP-UNKNOWN" );  
          final String parameters = Joiner.on( "," ).join( createParameters.apply( httpMessage ) );  
          createLogEntry( ctx, httpMessage.getMessage( ), method, parameters ); // HERE IS THE SINK 1  
        }  
      }  
    } catch ( Exception e1 ) {  
      Logger.getLogger( "LoggingError." + ServiceAccessLoggingHandler.class.getCanonicalName( ) ).debug( e1 );  
    }  
    ctx.sendUpstream( e );  
  }  
    
  @Override  
  public void handleDownstream( ChannelHandlerContext ctx, ChannelEvent e ) throws Exception {  
    if ( firstNonNull( StackConfiguration.LOG_REQUESTS, Boolean.TRUE ) ) try {  
      if ( e instanceof MessageEvent ) {  
        final MessageEvent msge = ( MessageEvent ) e;  
        if ( msge.getMessage( ) instanceof MappingHttpResponse ) {// Handle single request-response MEP  
          MappingHttpResponse httpMessage = ( MappingHttpResponse ) ( ( MessageEvent ) e ).getMessage( );  
          createLogEntry( ctx, httpMessage.getMessage( ), Objects.toString( httpMessage.getStatus(), "UNKNOWN" ) ); // HERE IS THE SINK 2  
        }  
      } else if ( e instanceof ExceptionEvent ) {  
        Throwable reply = ( ( ExceptionEvent ) e ).getCause( );  
        String[] extra = new String[]{};  
        try {  
          final List<Throwable> causalChain = Throwables.getCausalChain( reply );  
          extra = ( String[] ) Collections2.transform( causalChain, Functions.toStringFunction() ).toArray();  
        } catch ( Exception e1 ) {  
          Logger.getLogger( "LoggingError." + ServiceAccessLoggingHandler.class.getCanonicalName( ) ).debug( e1 );  
        }  
        createLogEntry( ctx, reply, extra ); // HERE IS THE SINK 3  
      }  
    } catch ( Exception e1 ) {  
      Logger.getLogger( "LoggingError." + ServiceAccessLoggingHandler.class.getCanonicalName( ) ).debug( e1 );  
    }  
    ctx.sendDownstream( e );  
  }  
  
// https://github.com/eucalyptus/eucalyptus/blob/95e0cef57eba3da26ed798317900da4eeac44263/clc/modules/msgs/src/main/java/com/eucalyptus/ws/protocol/RequestLoggingFilterDiscovery.java#L38-L61  
public class RequestLoggingFilterDiscovery extends ServiceJarDiscovery {  
  private final Logger logger = Logger.getLogger( RequestLoggingFilterDiscovery.class );  
  
  @Override  
  public boolean processClass( final Class candidate ) throws Exception {  
    boolean accepted = false;  
    if ( RequestLoggingFilter.class.isAssignableFrom( candidate ) &&  
        !Modifier.isAbstract( candidate.getModifiers( ) ) &&  
        Modifier.isPublic( candidate.getModifiers( ) ) ) {  
      try {  
        RequestLoggingFilters.register( (RequestLoggingFilter) candidate.newInstance() );  
        accepted = true;  
      } catch ( Exception e ) {  
        logger.error( "Error registering request logging filter " + candidate.getName( ), e );  
      }  
    }  
    return accepted;  
  }  
  
  @Override  
  public Double getPriority() {  
    return 0.3d;  
  }  
}  
  
// https://github.com/eucalyptus/eucalyptus/blob/95e0cef57eba3da26ed798317900da4eeac44263/clc/modules/msgs/src/main/java/com/eucalyptus/ws/Handlers.java#L635-L643  
  public static void addSystemHandlers( final ChannelPipeline pipeline ) {  
    pipeline.addLast( "service-state-check", internalServiceStateHandler( ) );  
    pipeline.addLast( "service-specific-mangling", ServiceHackeryHandler.INSTANCE );  
    if ( StackConfiguration.ASYNC_OPERATIONS ) {  
      pipeline.addLast( "async-operations-execution-handler", serviceExecutionHandler( ) );  
    }  
    pipeline.addLast( "service-request-handler", ServiceAccessLoggingHandler.INSTANCE  );  
    pipeline.addLast( "service-sink", new ServiceContextHandler( ) );  
  }  
  
// https://github.com/eucalyptus/eucalyptus/blob/95e0cef57eba3da26ed798317900da4eeac44263/clc/modules/msgs/src/main/java/com/eucalyptus/ws/server/NioServerHandler.java#L129-L153  
  private void lookupPipeline( final ChannelHandlerContext ctx, final MessageEvent e ) throws DuplicatePipelineException, NoAcceptingPipelineException {  
    try {  
      final HttpRequest request = ( HttpRequest ) e.getMessage( );  
      if ( Logs.isExtrrreeeme( ) && request instanceof MappingHttpMessage ) {  
        Logs.extreme( ).trace( ( ( MappingHttpMessage ) request ).logMessage( ) );  
      }  
      final FilteredPipeline filteredPipeline = Pipelines.find( request );  
      if ( this.pipeline.compareAndSet( null, filteredPipeline ) ) {  
        this.pipeline.get( ).unroll( ctx.getPipeline( ) );  
        if ( filteredPipeline instanceof InternalPipeline ) {  
          Handlers.addInternalSystemHandlers( ctx.getPipeline( ) );  
        }  
        final Ats ats = Ats.inClassHierarchy( filteredPipeline );  
        Handlers.addComponentHandlers(  
            ats.has(ComponentPart.class) ? ats.get(ComponentPart.class).value() : null,  
            ctx.getPipeline() );  
        Handlers.addSystemHandlers( ctx.getPipeline( ) );  
      }  
    } catch ( DuplicatePipelineException e1 ) {  
      LOG.error( "This is a BUG: " + e1, e1 );  
      throw e1;  
    } catch ( NoAcceptingPipelineException e2 ) {  
      throw e2;  
    }  
  }  
  
// https://github.com/eucalyptus/eucalyptus/blob/95e0cef57eba3da26ed798317900da4eeac44263/clc/modules/msgs/src/main/java/com/eucalyptus/ws/server/NioServerHandler.java#L91-L119  
  public void messageReceived( final ChannelHandlerContext ctx, final MessageEvent e ) throws Exception {  
    Callable<Long> stat = MessageStatistics.startUpstream(ctx.getChannel(), this);  
    try {  
      if ( this.pipeline.get( ) == null ) {  
        lookupPipeline( ctx, e );  
      } else if ( e.getMessage( ) instanceof MappingHttpRequest ) {  
        MappingHttpRequest httpRequest = ( MappingHttpRequest ) e.getMessage( );  
        if ( isPersistentConnection( httpRequest ) ) {  
          this.pipeline.set( null );  
          ChannelHandler p;  
          while ( ( p = ctx.getPipeline( ).getLast( ) ) != this ) {  
            ctx.getPipeline( ).remove( p );  
          }  
          lookupPipeline( ctx, e );  
        } else {  
          LOG.warn( "Hard close the socket on an attempt to do a second request." );  
          ctx.getChannel( ).close( );  
          return;  
        }  
      }  
      stat.call( );  
      ctx.sendUpstream( e );  
    } catch ( Exception ex ) {  
      LOG.trace( ex );  
      Logs.extreme( ).error( ex, ex );  
      stat.call( );  
      this.sendError( ctx, e, HttpResponseStatus.NOT_FOUND, ex );  
    }  
  }  
  
// https://github.com/eucalyptus/eucalyptus/blob/95e0cef57eba3da26ed798317900da4eeac44263/clc/modules/euare-common/src/main/java/com/eucalyptus/auth/euare/EuareMessages.groovy#L635-L641  
  
@PolicyAction( vendor = PolicySpec.VENDOR_IAM, action = IamPolicySpec.IAM_CREATELOGINPROFILE )  
public class CreateLoginProfileType extends EuareMessage implements EuareMessageWithDelegate {  
  String delegateAccount;  
  String userName;  
  String password;  
  public CreateLoginProfileType() {  }  
}  
  
// https://github.com/eucalyptus/eucalyptus/blob/95e0cef57eba3da26ed798317900da4eeac44263/clc/modules/euare-common/src/main/resources/euare-binding.xml#L487-L492  
  
  <mapping name="CreateLoginProfile" class="com.eucalyptus.auth.euare.CreateLoginProfileType" extends="com.eucalyptus.auth.euare.EuareMessage">  
    <structure map-as="com.eucalyptus.auth.euare.EuareMessage"/>  
    <value name="DelegateAccount" field="delegateAccount" usage="optional"/>  
    <value name="UserName" field="userName" usage="required"/>  
    <value name="Password" field="password" usage="required"/>  
  </mapping>  
  
```  
