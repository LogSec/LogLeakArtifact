## Summary:  
Software: nifi  
## Fix:  
Commit: https://github.com/apache/nifi/pull/4222/commits/a1ce9103b1939f961401fa9c9d719518b30cfbaf  
Author: Andy LoPresto  
Fix Time (of the Last Commit): 2020-04-22  
Fix Pattern: Sanitization -> Redaction -> Introduction  
  
  
Fixing-commits Count: 7  
Total Change Size: +679 -100  
  

========  
https://github.com/apache/nifi/pull/4222/commits/799b256d36cb80ff6838d399ade8fdce626921c6  
https://github.com/apache/nifi/pull/4222/commits/a5f622377283fbd11f1b34bf42332045560168fd  
https://github.com/apache/nifi/pull/4222/commits/e91176a7f728245dce83de23cccedb253842ee88  
https://github.com/apache/nifi/pull/4222/commits/a1ce9103b1939f961401fa9c9d719518b30cfbaf  
https://github.com/apache/nifi/pull/4222/commits/e2cb8163cfc155c0f32f5b92adaeaa2dc1abcf04  
https://github.com/apache/nifi/pull/4222/commits/3bba02a93bbd782a453955fe7c6506c6521648cf  
https://github.com/apache/nifi/pull/4222/commits/6b94ac796f7bdbb393ca5834403a5041ef092cc0  
  
PR: https://github.com/apache/nifi/pull/4222  
## Sample logs: No  
## Logging statements:  
### Source labels:  
Type of Sensitive Information:authentication data -> sensitive property values  
### Sink labels:  
#### Sink 1:  
Logging call Function:  Standard Libraries（System.out.println）  
Sensitiveness-Identifiable Source:  Same Projects & Cross Modules（https://github.com/alopresto/nifi/blob/6b94ac796f7bdbb393ca5834403a5041ef092cc0/nifi-nar-bundles/nifi-standard-services/nifi-hadoop-dbcp-service-bundle/nifi-hadoop-dbcp-service/src/main/java/org/apache/nifi/dbcp/HadoopDBCPConnectionPool.java#L141） -> Variable Names(DB_PASSWORD)  
#### Sink 2:  
Logging call Function:  Standard Libraries（System.out.println）  
Sensitiveness-Identifiable Source:  Same Projects & Cross Modules（https://github.com/alopresto/nifi/blob/6b94ac796f7bdbb393ca5834403a5041ef092cc0/nifi-nar-bundles/nifi-standard-services/nifi-hadoop-dbcp-service-bundle/nifi-hadoop-dbcp-service/src/main/java/org/apache/nifi/dbcp/HadoopDBCPConnectionPool.java#L141） -> Variable Names(DB_PASSWORD)  
#### Sink 3:  
Logging call Function:  Standard Libraries（System.out.println）  
Sensitiveness-Identifiable Source:  Same Projects & Cross Modules（https://github.com/alopresto/nifi/blob/6b94ac796f7bdbb393ca5834403a5041ef092cc0/nifi-nar-bundles/nifi-standard-services/nifi-hadoop-dbcp-service-bundle/nifi-hadoop-dbcp-service/src/main/java/org/apache/nifi/dbcp/HadoopDBCPConnectionPool.java#L141） -> Variable Names(DB_PASSWORD)  
#### Sink 4:  
Logging call Function:  Standard Libraries（System.out.println）  
Sensitiveness-Identifiable Source:  Same Projects & Cross Modules（https://github.com/alopresto/nifi/blob/6b94ac796f7bdbb393ca5834403a5041ef092cc0/nifi-nar-bundles/nifi-standard-services/nifi-hadoop-dbcp-service-bundle/nifi-hadoop-dbcp-service/src/main/java/org/apache/nifi/dbcp/HadoopDBCPConnectionPool.java#L141） -> Variable Names(DB_PASSWORD)  
#### Sink 5:  
Logging call Function:  Standard Libraries（System.out.println）  
Sensitiveness-Identifiable Source:  Same Projects & Cross Modules（https://github.com/alopresto/nifi/blob/6b94ac796f7bdbb393ca5834403a5041ef092cc0/nifi-nar-bundles/nifi-standard-services/nifi-hadoop-dbcp-service-bundle/nifi-hadoop-dbcp-service/src/main/java/org/apache/nifi/dbcp/HadoopDBCPConnectionPool.java#L141） -> Variable Names(DB_PASSWORD)  
#### Sink 6:  
Logging call Function:  Standard Libraries（System.out.println）  
Sensitiveness-Identifiable Source:  Same Methods & Cross Statements（邻近，https://github.com/alopresto/nifi/blob/6b94ac796f7bdbb393ca5834403a5041ef092cc0/nifi-nar-bundles/nifi-framework-bundle/nifi-framework/nifi-stateless/src/main/java/org/apache/nifi/stateless/runtimes/openwhisk/StatelessNiFiOpenWhiskAction.java#L140） -> Comments  
#### Sink 7:  
Logging call Function:  Standard Libraries（System.out.println）  
Sensitiveness-Identifiable Source:  Same Methods & Cross Statements（邻近，https://github.com/alopresto/nifi/blob/6b94ac796f7bdbb393ca5834403a5041ef092cc0/nifi-nar-bundles/nifi-framework-bundle/nifi-framework/nifi-stateless/src/main/java/org/apache/nifi/stateless/runtimes/openwhisk/StatelessNiFiOpenWhiskAction.java#L140） -> Comments  
#### Sink 8:  
Logging call Function:  Standard Libraries（System.out.println）  
Sensitiveness-Identifiable Source:  Same Projects & Cross Modules（https://github.com/alopresto/nifi/blob/6b94ac796f7bdbb393ca5834403a5041ef092cc0/nifi-nar-bundles/nifi-standard-services/nifi-hadoop-dbcp-service-bundle/nifi-hadoop-dbcp-service/src/main/java/org/apache/nifi/dbcp/HadoopDBCPConnectionPool.java#L141） -> Variable Names(DB_PASSWORD)  
#### Sink 9:  
Logging call Function:  Standard Libraries（System.out.println）  
Sensitiveness-Identifiable Source:  Same Projects & Cross Modules（https://github.com/alopresto/nifi/blob/6b94ac796f7bdbb393ca5834403a5041ef092cc0/nifi-nar-bundles/nifi-standard-services/nifi-hadoop-dbcp-service-bundle/nifi-hadoop-dbcp-service/src/main/java/org/apache/nifi/dbcp/HadoopDBCPConnectionPool.java#L141） -> Variable Names(DB_PASSWORD)  
Programming Language:Java  
```Java  
// https://github.com/alopresto/nifi/blob/6b94ac796f7bdbb393ca5834403a5041ef092cc0/nifi-nar-bundles/nifi-framework-bundle/nifi-framework/nifi-stateless/src/main/java/org/apache/nifi/stateless/core/StatelessFlow.java#L383-L389  
  
    public static StatelessFlow createAndEnqueueFromJSON(final JsonObject jsonObject, final ClassLoader systemClassLoader, final File narWorkingDir)  
            throws InitializationException, IOException, ProcessorInstantiationException, NiFiRegistryException {  
        if (jsonObject == null) {  
            throw new IllegalArgumentException("Flow arguments can not be null");  
        }  
  
        System.out.println("Running flow from json: " + StatelessSecurityUtility.getLoggableRepresentationOfJsonObject(jsonObject)); // HERE IS THE SINK 1  
  
// https://github.com/alopresto/nifi/blob/6b94ac796f7bdbb393ca5834403a5041ef092cc0/nifi-nar-bundles/nifi-framework-bundle/nifi-framework/nifi-stateless/src/main/java/org/apache/nifi/stateless/runtimes/Program.java#L58-L173  
  
    public static void launch(final String[] args, final ClassLoader systemClassLoader, final File narWorkingDirectory) throws Exception {  
  
        //Workaround for YARN  
        //TODO make configurable  
        String hadoopTokenFileLocation = System.getenv("HADOOP_TOKEN_FILE_LOCATION");  
        if (hadoopTokenFileLocation != null && !hadoopTokenFileLocation.equals("")) {  
            File targetFile = new File(hadoopTokenFileLocation);  
            File parent = targetFile.getParentFile();  
            if (!parent.exists() && !parent.mkdirs()) {  
                throw new IllegalStateException("Couldn't create dir: " + parent);  
            }  
            try (FileOutputStream fos = new FileOutputStream(targetFile)) {  
                fos.write("HDTS".getBytes(StandardCharsets.UTF_8));  
                fos.write((byte) 0x00);  
                fos.write((byte) 0x00);  
                fos.write((byte) 0x00);  
            }  
            System.out.println("Created empty hadoop token file: " + System.getenv("HADOOP_TOKEN_FILE_LOCATION"));  
        }  
  
  
        if (args.length == 0) {  
            printUsage();  
            System.exit(1);  
        } else if (args[0].equals(RUN_FROM_REGISTRY) && (args[1].equalsIgnoreCase("Once") || args[1].equalsIgnoreCase("Continuous")) && args.length >= 4) {  
            runLocal(args, systemClassLoader, narWorkingDirectory);  
        } else if (args[0].equals(RUN_YARN_SERVICE_FROM_REGISTRY) && args.length >= 7) {  
            runOnYarn(args);  
        } else if (args[0].equals(RUN_OPENWHISK_ACTION_SERVER) && args.length == 2) {  
            runOnOpenWhisk(args, systemClassLoader, narWorkingDirectory);  
        } else {  
            System.out.println("Invalid input: " + formatArgs(args)); // HERE IS THE SINK 2  
            printUsage();  
            System.exit(1);  
        }  
    }  
  
    private static void runOnOpenWhisk(final String[] args, final ClassLoader systemClassLoader, final File narWorkingDirectory) throws IOException {  
        StatelessNiFiOpenWhiskAction action = new StatelessNiFiOpenWhiskAction(Integer.parseInt(args[1]), systemClassLoader, narWorkingDirectory);  
        action.start();  
    }  
  
    private static void runOnYarn(final String[] args) throws IOException {  
        String YARNUrl = args[1];  
        String imageName = args[2];  
        String serviceName = args[3];  
        int numberOfContainers = Integer.parseInt(args[4]);  
        String json;  
  
        if (args[5].equals(FILE_FLAG)) {  
            json = new String(Files.readAllBytes(Paths.get(args[6])));  
        } else if (args[5].equals(JSON_FLAG)) {  
            json = args[6];  
        } else {  
            System.out.println("Invalid input: " + formatArgs(args)); // HERE IS THE SINK 3  
            printUsage();  
            System.exit(1);  
            return;  
        }  
        String[] launchCommand = {  
                RUN_FROM_REGISTRY,  
                "Continuous",  
                JSON_FLAG,  
                new JsonParser().parse(json).toString() //validate and minify  
        };  
  
        StringBuilder message = new StringBuilder();  
        YARNServiceUtil yarnServiceUtil = new YARNServiceUtil(YARNUrl, imageName);  
        yarnServiceUtil.launchYARNService(serviceName, numberOfContainers, launchCommand, message);  
        System.out.println(message);  
    }  
  
    private static void runLocal(final String[] args, final ClassLoader systemClassLoader, final File narWorkingDirectory) throws Exception {  
        final boolean once = args[1].equalsIgnoreCase("Once");  
  
        final String json;  
        if (args[2].equals(FILE_FLAG)) {  
            json = new String(Files.readAllBytes(Paths.get(args[3])));  
        } else if (args[2].equals(JSON_FLAG)) {  
            json = args[3];  
        } else if (args[2].equals(YARN_JSON_FLAG)) {  
            json = args[3].replace(';', ',');  
        } else {  
            System.out.println("Invalid input: " + formatArgs(args)); // HERE IS THE SINK 4  
            printUsage();  
            System.exit(1);  
            return;  
        }  
  
        JsonObject jsonObject = new JsonParser().parse(json).getAsJsonObject();  
        System.out.println("Running from json: " + StatelessSecurityUtility.formatJson(jsonObject));  // HERE IS THE SINK 5  
        final RunnableFlow flow = StatelessFlow.createAndEnqueueFromJSON(jsonObject, systemClassLoader, narWorkingDirectory);  
  
        // Run Flow  
        final Queue<InMemoryFlowFile> outputFlowFiles = new LinkedList<>();  
        final boolean successful;  
        if (once) {  
            successful = flow.runOnce(outputFlowFiles);  
        } else {  
            successful = flow.run(outputFlowFiles);  //Run forever  
        }  
  
        // TODO: Introduce verbose flag to determine if flowfiles should be printed on completion  
        if (successful) {  
            System.out.println("Flow Succeeded");  
            if (isVerbose) {  
                outputFlowFiles.forEach(f -> System.out.println(f.toStringFull()));  
            }  
        } else {  
            System.out.println("Flow Failed");  
            if (isVerbose) {  
                outputFlowFiles.forEach(f -> System.out.println(f.toStringFull()));  
            }  
            System.exit(1);  
        }  
    }  
  
// https://github.com/alopresto/nifi/blob/6b94ac796f7bdbb393ca5834403a5041ef092cc0/nifi-nar-bundles/nifi-framework-bundle/nifi-framework/nifi-stateless/src/main/java/org/apache/nifi/stateless/runtimes/openwhisk/StatelessNiFiOpenWhiskAction.java#L122-L194  
  
    private class RunHandler implements HttpHandler {  
        public void handle(HttpExchange t) throws IOException {  
            if (!initialized) {  
                writeResponse(t, 500, "Cannot invoke an uninitialized action.");  
                return;  
            }  
  
            try {  
                InputStream is = t.getRequestBody();  
                JsonParser parser = new JsonParser();  
                JsonObject body = parser.parse(new BufferedReader(new InputStreamReader(is, StandardCharsets.UTF_8))).getAsJsonObject();  
                JsonObject inputObject = body.getAsJsonObject("value");  
                /*  
                input body :  
                    {  
                        "activation_id":"e212d293aa73479d92d293aa73c79dc9",  
                        "action_name":"/guest/nifistateless",  
                        "deadline":"1541729057462",  
                        "api_key":"23bc46b1-71f6-4ed5-8c54-816aa4f8c500:123zO3xZCLrMN6v2BKK1dXYFpXlPkccOFqm12CdAsMgRU4VrNZ9lyGVCGuMDGIwP",  
                        "value":{"registry":"http://172.26.224.116:61080","SourceCluster":"hdfs://172.26.224.119:8020","SourceFile":"test.txt",  
                        "SourceDirectory":"hdfs://172.26.224.119:8020/tmp/nifistateless/input/","flow":"6cf8277a-c402-4957-8623-0fa9890dd45d","bucket":"e53b8a0d-5c85-4fcd-912a-1c549a586c83",  
                        "DestinationDirectory":"hdfs://172.26.224.119:8020/tmp/nifistateless/output"},  
                        "namespace":"guest"  
                    }  
                input headers:  
                    Accept-encoding: [gzip,deflate]  
                    Accept: [application/json]  
                    Connection: [Keep-Alive]  
                    Host: [10.0.0.166:8080]  
                    User-agent: [Apache-HttpClient/4.5.5 (Java/1.8.0-adoptopenjdk)]  
                    Content-type: [application/json]  
                    Content-length: [595]  
                 */  
  
                // Run Flow  
                Queue<InMemoryFlowFile> output = new LinkedList<>();  
                boolean successful;  
                if (flow == null) {  
                    System.out.println(StatelessSecurityUtility.formatJson(inputObject)); // HERE IS THE SINK 6  
  
                    final JsonObject config = new JsonParser().parse(inputObject.get("code").getAsJsonPrimitive().getAsString()).getAsJsonObject();  
                    RunnableFlow tempFlow = StatelessFlow.createAndEnqueueFromJSON(config, systemClassLoader, narWorkingDirectory);  
                    successful = tempFlow.runOnce(output);  
                } else {  
                    System.out.println("Input: " + StatelessSecurityUtility.formatJson(inputObject)); // HERE IS THE SINK 7  
  
                    Map<String,String> Attributes = inputObject.entrySet()  
                            .stream()  
                            .collect(Collectors.toMap(Map.Entry::getKey, item -> item.getValue().getAsString()));  
                    ((StatelessFlow)flow).enqueueFlowFile(new byte[0],Attributes);  
                    successful = flow.runOnce(output);  
                }  
  
                StringBuilder response = new StringBuilder();  
                for (InMemoryFlowFile flowFile : output) {  
                    response.append("\n").append(flowFile);  
                }  
  
                writeResponse(t, successful ? 200 : 500, response.toString());  
  
            } catch (Exception e) {  
                e.printStackTrace(System.err);  
                StringWriter sw = new StringWriter();  
                PrintWriter pw = new PrintWriter(sw);  
                e.printStackTrace(pw);  
                String sStackTrace = sw.toString();  
                // TODO: This leaks the stacktrace in the HTTP response  
                writeResponse(t, 500, "An error has occurred (see logs for details): " + e.getMessage()+"\n"+sStackTrace);  
            } finally {  
                writeLogMarkers();  
            }  
        }  
    }  
  
// https://github.com/alopresto/nifi/blob/6b94ac796f7bdbb393ca5834403a5041ef092cc0/nifi-nar-bundles/nifi-framework-bundle/nifi-framework/nifi-stateless/src/main/java/org/apache/nifi/stateless/runtimes/yarn/YARNServiceUtil.java#L39-L101  
  
    public boolean launchYARNService(String name, int containerCount, String[] argLaunchCommand, StringBuilder outMessage) {  
  
        //YARN cannot handle commas in a launch command...  
        String[] updatedLaunchCommand = new String[argLaunchCommand.length];  
        for(int i = 0; i < argLaunchCommand.length; i++){  
            if(argLaunchCommand[i].equals("--json"))  
                updatedLaunchCommand[i] = "--yarnjson";  
            else  
                updatedLaunchCommand[i] = argLaunchCommand[i]  
                        .replace(',',';')  
                        .replace("}}","} }");  
        }  
  
        JsonObject spec = new JsonObject();  
        spec.addProperty("name", name.substring(0, Math.min(name.length(), 25))); //truncate name  
        spec.addProperty("version", "1.0.0");  
        spec.addProperty("description", "Stateless NiFi service");  
  
        JsonObject component = new JsonObject();  
        component.addProperty("name", "mc");  
        component.addProperty("number_of_containers", containerCount);  
  
        JsonObject artifact = new JsonObject();  
        artifact.addProperty("id", this.imageName);  
        artifact.addProperty("type", "DOCKER");  
        component.add("artifact", artifact);  
  
        component.addProperty("launch_command", String.join(",", updatedLaunchCommand));  
  
        JsonObject resource = new JsonObject();  
        resource.addProperty("cpus", 1);  
        resource.addProperty("memory", "512");  
        component.add("resource", resource);  
  
        JsonObject env = new JsonObject();  
        env.addProperty("YARN_CONTAINER_RUNTIME_DOCKER_RUN_OVERRIDE_DISABLE", "true");  
        JsonObject configuration = new JsonObject();  
        configuration.add("env", env);  
        component.add("configuration", configuration);  
  
        JsonArray components = new JsonArray();  
        components.add(component);  
        spec.add("components", components);  
  
        HttpPost request = new HttpPost(  
            this.YARNUrl + "/app/v1/services?user.name=" + System.getProperty("user.name")  
        );  
        System.out.println("Running YARN service with the following definition:");  
        System.out.println(StatelessSecurityUtility.formatJson(spec)); // HERE IS THE SINK 8  
        System.out.println("Launch Command");  
        System.out.println(StatelessSecurityUtility.formatArgs(updatedLaunchCommand, true)); // HERE IS THE SINK 9  
  
        try {  
            request.setEntity(new StringEntity(spec.toString(), " application/json", StandardCharsets.UTF_8.toString()));  
            HttpResponse response = HttpClientBuilder.create().build().execute(request);  
            outMessage.append(new BasicResponseHandler().handleResponse(response));  
            return true;  
        } catch (IOException e) {  
            e.printStackTrace();  
            outMessage.append(e.getMessage());  
            return false;  
        }  
    }  
  
```  
