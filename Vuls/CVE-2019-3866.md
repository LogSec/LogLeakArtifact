## Summary:  
Software: openstack/mistral  
## Fix:  
Commit: https://github.com/openstack/mistral/commit/a25c8fab881decff0e61deffe1895f1d99132f9f  
Fix Time (of the Last Commit): 2019-11-15  
Author: Dougal Matthews  
Fix Pattern: Sanitization -> Redaction -> Introduction -> Keyword/RegexBasedFiltration -> RedactionFunctionDefined  
  
  
  
Fixing-commits Count: 3  
Total Change Size: +102 -22  
  
========  
Commit: https://github.com/openstack/oslo.utils/commit/b41268417cecb12d1d5955ee3107067edf050221  
Change Size: +64 -14  
Commit time: 2019-11-05  
Commit: https://github.com/openstack/mistral-lib/commit/f51d2a21c0e75fe0e20990877e0615d4ace6af89  
Change Size: +37 -1  
Commit time: 2019-11-05  
Commit: https://github.com/openstack/mistral/commit/a25c8fab881decff0e61deffe1895f1d99132f9f  
Change Size: +1 -7  
Commit time: 2019-11-15  
## Sample logs: Yes  
```  
2019-10-30 07:16:10.083 1 INFO mistral.engine.engine_server [req-1f9f6b40-3f82-479d-9960-3a9b13f57f88 734f9f46f9bd4298951bc155c6ba42bd 9481b04b8a9b44bc91bd2f7a78cc57a8 - default default] Received RPC request 'on_action_complete'[action_ex_id=90af917e-96f6-4bfe-ac86-93c473414336, result=Result [data={passwords: {u'KeystoneFernetKey1': u'ctgEMxw0.... u'OctaviaCaKeyPassphrase': u'Uk... , u'SSLKey': u'-----BEGIN PRIVATE KEY-----.... }  
```  
## Logging statements:  
### Source labels:  
Type of Sensitive Information: authentication data -> sensitive user information  
### Sink labels:  
#### Sink 1:  
Logging call Function:  Standard Libraries（Python logging）  
Sensitiveness-Identifiable Source:  Cross Projects|Cross-System（https://github.com/openstack/tripleo-common/blob/4478e12f920461e179e0d59240b5c482d92b36b8/workbooks/plan_management.yaml#L460） -> Configurations  
#### Sink 2:  
Logging call Function:  User-defined（PythonAction._log_result）  
Sensitiveness-Identifiable Source:  Cross Projects|Cross-System（https://github.com/openstack/tripleo-common/blob/4478e12f920461e179e0d59240b5c482d92b36b8/workbooks/plan_management.yaml#L460） -> Configurations  
Programming Language:Python  
```python  
  
# https://github.com/openstack/tripleo-common/blob/4478e12f920461e179e0d59240b5c482d92b36b8/workbooks/plan_management.yaml#L440-L484  
  get_passwords:  
    description: Retrieves passwords for a given plan  
    input:  
      - container  
      - queue_name: tripleo  
  
    tags:  
      - tripleo-common-managed  
  
    tasks:  
  
      verify_container_exists:  
        workflow: tripleo.swift.v1.container_exists container=<% $.container %>  
        on-success: get_environment_passwords  
        publish-on-error:  
          status: FAILED  
          message: <% task().result %>  
        on-error: send_message  
  
      get_environment_passwords:  
        action: tripleo.parameters.get_passwords container=<% $.container %>  
        on-success: get_passwords_set_status_success  
        on-error: get_passwords_set_status_failed  
  
      get_passwords_set_status_success:  
        on-success: send_message  
        publish:  
          status: SUCCESS  
          message: <% task(get_environment_passwords).result %>  
  
      get_passwords_set_status_failed:  
        on-success: send_message  
        publish:  
          status: FAILED  
          message: <% task(get_environment_passwords).result %>  
  
      send_message:  
        workflow: tripleo.messaging.v1.send  
        input:  
          queue_name: <% $.queue_name %>  
          type: <% execution().name %>  
          status: <% $.status %>  
          execution: <% execution() %>  
          plan_name: <% $.container %>  
          message: <% $.get('message', '') %>  
  
# https://github.com/openstack/tripleo-common/blob/4478e12f920461e179e0d59240b5c482d92b36b8/tripleo_common/actions/parameters.py#L342-L374  
class GetPasswordsAction(base.TripleOAction):  
    """Get passwords from the environment  
    This method returns the list passwords which are used for the deployment.  
    It will return a merged list of user provided passwords and generated  
    passwords, giving priority to the user provided passwords.  
    """  
  
    def __init__(self, container=constants.DEFAULT_CONTAINER_NAME):  
        super(GetPasswordsAction, self).__init__()  
        self.container = container  
  
    def run(self, context):  
        swift = self.get_object_client(context)  
  
        try:  
            env = plan_utils.get_env(swift, self.container)  
        except swiftexceptions.ClientException as err:  
            err_msg = ("Error retrieving environment for plan %s: %s" % (  
                self.container, err))  
            LOG.exception(err_msg)  
            return actions.Result(error=err_msg)  
  
        parameter_defaults = env.get('parameter_defaults', {})  
        passwords = env.get('passwords', {})  
  
        return self._get_overriden_passwords(passwords, parameter_defaults)  
  
    def _get_overriden_passwords(self, env_passwords, parameter_defaults):  
        for name in constants.PASSWORD_PARAMETER_NAMES:  
            if name in parameter_defaults:  
                env_passwords[name] = parameter_defaults[name]  
        return env_passwords  
  
  
# https://github.com/openstack/mistral/blob/c0857a7a952c4da04a85dbdde962d37ded00dfff/mistral/engine/engine_server.py#L147-L163  
    def on_action_complete(self, rpc_ctx, action_ex_id, result, wf_action):  
        """Receives RPC calls to communicate action result to engine.  
        :param rpc_ctx: RPC request context.  
        :param action_ex_id: Action execution id.  
        :param result: Action result data.  
        :param wf_action: True if given id points to a workflow execution.  
        :return: Action execution.  
        """  
        LOG.info(  
            "Received RPC request 'on_action_complete'[action_ex_id=%s, "  
            "result=%s]",  
            action_ex_id,  
            result.cut_repr() if result else '<unknown>'  
        ) # HERE IS THE SINK 1  
  
        return self.engine.on_action_complete(action_ex_id, result, wf_action)  
  
# https://github.com/openstack/mistral/blob/c0857a7a952c4da04a85dbdde962d37ded00dfff/mistral/engine/actions.py#L212-L240  
class PythonAction(Action):  
    """Regular Python action."""  
  
    def __init__(self, action_def, action_ex=None, task_ex=None):  
        super(PythonAction, self).__init__(action_def, action_ex, task_ex)  
  
        self._prepared_input = None  
  
    @profiler.trace('action-complete', hide_args=True)  
    def complete(self, result):  
        assert self.action_ex  
  
        if states.is_completed(self.action_ex.state):  
            raise ValueError(  
                "Action {} is already completed".format(self.action_ex.id))  
  
        prev_state = self.action_ex.state  
  
        if result.is_success():  
            self.action_ex.state = states.SUCCESS  
        elif result.is_cancel():  
            self.action_ex.state = states.CANCELLED  
        else:  
            self.action_ex.state = states.ERROR  
  
        self.action_ex.output = self._prepare_output(result).to_dict()  
        self.action_ex.accepted = True  
  
        self._log_result(prev_state, result) # HERE IS THE SINK 2  
  
# https://github.com/openstack/mistral/blob/c0857a7a952c4da04a85dbdde962d37ded00dfff/mistral/engine/actions.py#L189-L209  
  
    @profiler.trace('action-log-result', hide_args=True)  
    def _log_result(self, prev_state, result):  
        state = self.action_ex.state  
  
        def _result_msg():  
            if state == states.ERROR:  
                return "error = %s" % utils.cut(result.error)  
  
            return "result = %s" % utils.cut(result.data)  
  
        if prev_state != state:  
            wf_trace.info(  
                None,  
                "Action '%s' (%s)(task=%s) [%s -> %s, %s]" %  
                (self.action_ex.name,  
                 self.action_ex.id,  
                 self.task_ex.name if self.task_ex else None,  
                 prev_state,  
                 state,  
                 _result_msg())  
            ) # HERE IS THE INNER SINK  
  
```  
