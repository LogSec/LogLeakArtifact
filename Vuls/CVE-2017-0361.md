## Summary:  
Software: mediawiki  
## Fix:  
Commit: https://github.com/wikimedia/mediawiki/commit/4d38a489b075fbd0a4c9ec228f83295cf9b9c5fc  
Change Size: +47 -3  
Author: Brad Jorsch  
Fix Time (of the Last Commit): 2017-04-07  
Fix Pattern: Sanitization -> Redaction -> Introduction -> Tag/TypeBasedFiltration -> NoRedactionFunctionDefined	  
  
Fixing-commits Count: 1  
Total Change Size: +47 -3  
## Sample logs: No  
## Logging statements:  
### Source labels:  
Type of Sensitive Information:authentication data -> passwords  
### Sink labels:  
#### Sink 1:  
Logging call Function:  User-defined（logRequest）  
Sensitiveness-Identifiable Source:  Same Modules & Cross Files（https://github.com/wikimedia/mediawiki/blob/4d38a489b075fbd0a4c9ec228f83295cf9b9c5fc/includes/api/ApiLogin.php#L246,实际上没有找到确切的路径） -> String Literals（password，finally outputed to logs）  
#### Sink 2:  
Logging call Function:  User-defined（logRequest）  
Sensitiveness-Identifiable Source:  Same Modules & Cross Files（https://github.com/wikimedia/mediawiki/blob/4d38a489b075fbd0a4c9ec228f83295cf9b9c5fc/includes/api/ApiLogin.php#L246，实际上没有找到确切的路径） -> String Literals（password，finally outputed to logs）  
Programming Language:PHP  
```PHP  
  
// https://github.com/wikimedia/mediawiki/blob/4d38a489b075fbd0a4c9ec228f83295cf9b9c5fc/includes/api/ApiMain.php#L1576-L1630  
  
	/**  
	 * Log the preceding request  
	 * @param float $time Time in seconds  
	 * @param Exception $e Exception caught while processing the request  
	 */  
	protected function logRequest( $time, $e = null ) {  
		$request = $this->getRequest();  
		$logCtx = [  
			'ts' => time(),  
			'ip' => $request->getIP(),  
			'userAgent' => $this->getUserAgent(),  
			'wiki' => wfWikiID(),  
			'timeSpentBackend' => (int)round( $time * 1000 ),  
			'hadError' => $e !== null,  
			'errorCodes' => [],  
			'params' => [],  
		];  
  
		if ( $e ) {  
			foreach ( $this->errorMessagesFromException( $e ) as $msg ) {  
				$logCtx['errorCodes'][] = $msg->getApiCode();  
			}  
		}  
  
		// Construct space separated message for 'api' log channel  
		$msg = "API {$request->getMethod()} " .  
			wfUrlencode( str_replace( ' ', '_', $this->getUser()->getName() ) ) .  
			" {$logCtx['ip']} " .  
			"T={$logCtx['timeSpentBackend']}ms";  
  
		$sensitive = array_flip( $this->getSensitiveParams() );  
		foreach ( $this->getParamsUsed() as $name ) {  
			$value = $request->getVal( $name );  
			if ( $value === null ) {  
				continue;  
			}  
  
			if ( isset( $sensitive[$name] ) ) {  
				$value = '[redacted]';  
				$encValue = '[redacted]';  
			} elseif ( strlen( $value ) > 256 ) {  
				$value = substr( $value, 0, 256 );  
				$encValue = $this->encodeRequestLogValue( $value ) . '[...]';  
			} else {  
				$encValue = $this->encodeRequestLogValue( $value );  
			}  
  
			$logCtx['params'][$name] = $value;  
			$msg .= " {$name}={$encValue}";  
		}  
  
		wfDebugLog( 'api', $msg, 'private' );  
		// ApiAction channel is for structured data consumers  
		wfDebugLog( 'ApiAction', '', 'private', $logCtx );  
	}  
  
// https://github.com/wikimedia/mediawiki/blob/4d38a489b075fbd0a4c9ec228f83295cf9b9c5fc/includes/api/ApiMain.php#L520-L571  
  
	/**  
	 * Execute an action, and in case of an error, erase whatever partial results  
	 * have been accumulated, and replace it with an error message and a help screen.  
	 */  
	protected function executeActionWithErrorHandling() {  
		// Verify the CORS header before executing the action  
		if ( !$this->handleCORS() ) {  
			// handleCORS() has sent a 403, abort  
			return;  
		}  
  
		// Exit here if the request method was OPTIONS  
		// (assume there will be a followup GET or POST)  
		if ( $this->getRequest()->getMethod() === 'OPTIONS' ) {  
			return;  
		}  
  
		// In case an error occurs during data output,  
		// clear the output buffer and print just the error information  
		$obLevel = ob_get_level();  
		ob_start();  
  
		$t = microtime( true );  
		$isError = false;  
		try {  
			$this->executeAction();  
			$runTime = microtime( true ) - $t;  
			$this->logRequest( $runTime ); // HERE IS THE SINK 1  
			if ( $this->mModule->isWriteMode() && $this->getRequest()->wasPosted() ) {  
				MediaWikiServices::getInstance()->getStatsdDataFactory()->timing(  
					'api.' . $this->mModule->getModuleName() . '.executeTiming', 1000 * $runTime  
				);  
			}  
		} catch ( Exception $e ) {  
			$this->handleException( $e );  
			$this->logRequest( microtime( true ) - $t, $e ); // HERE IS THE SINK 2  
			$isError = true;  
		}  
  
		// Commit DBs and send any related cookies and headers  
		MediaWiki::preOutputCommit( $this->getContext() );  
  
		// Send cache headers after any code which might generate an error, to  
		// avoid sending public cache headers for errors.  
		$this->sendCacheHeaders( $isError );  
  
		// Executing the action might have already messed with the output  
		// buffers.  
		while ( ob_get_level() > $obLevel ) {  
			ob_end_flush();  
		}  
	}  
  
```  
