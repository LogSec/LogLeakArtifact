## Summary:  
Software: bad_behavior  
## Fix:  
Commit: https://git.drupalcode.org/project/badbehavior/commit/d7d8602  
Change Size: +38 -0  
Author: Sean Robertson  
Fix Time (of the Last Commit): 2014-10-22  
Fix Pattern: Sanitization -> Redaction -> Introduction -> Other -> RedactionFunctionDefined  
Fixing-commits Count: 1  
Total Change Size: +38 0  
## Sample logs: No  
## Logging statements:  
### Source labels:  
Type of Sensitive Information:authentication data -> usernames and passwords  
### Sink labels:  
#### Sink 1:  
Logging call Function:  Third-party Libaries（db_query）  
Sensitiveness-Identifiable Source:  Cross Projects|Cross-Libraries -> Variable Names  
Programming Language:PHP  
```PHP  
  
// https://git.drupalcode.org/project/badbehavior/-/blob/d7d8602f846362993ff0761fa3cfeb60e7360103/badbehavior.module#L163-172  
  
function bb2_db_query($query) {  
  set_error_handler('badbehavior_db_errortrap');  
  // Remove security-sensitive data  
  $query = badbehavior_strip_passwords($query);  
  $result = db_query($query); // HERE IS THE SINK 1  
  restore_error_handler();  
  if ($result == FALSE)  
    return FALSE;  
  return db_affected_rows();  
}  
  
// https://git.drupalcode.org/project/badbehavior/-/blob/d7d8602f846362993ff0761fa3cfeb60e7360103/badbehavior.module#L269-303  
/**  
 * Strip out reporting of values from forms containing sensitive data  
 * Looking for query like this:  
 * INSERT INTO `{bad_behavior_log}` (....,`request_entity`,...) VALUES (...,'request_entity_post_values',...)  
 * where request_entity_post_values contains specific strings.  
 * The only string coded for by default is 'form_iduser_login' which is found in login form  
 * post data (after escaping).  
 *  
 * @param string $query  
 */  
function badbehavior_strip_passwords($query) {  
  if (preg_match('/INSERT INTO (.*)`request_entity`/', $query)) {  
    $prohibit = variable_get('badbehavior_hide_post_strings', array('form_iduser_login'));  
    $matches = array();  
    if (preg_match('/INSERT INTO (.*) \((.*)\) VALUES \((.*)\)/', $query, $matches)) {  
      if (trim($matches[1]) == '`{bad_behavior_log}`') {  
        $fields = explode(',', $matches[2]);  
        $values = explode(',', $matches[3]);  
        foreach ($fields as $i => $f) {  
          if (trim($f) == '`request_entity`') {  
            foreach ($prohibit as $txt) {  
              if (strstr($values[$i], $txt) !== false) {  
                $values[$i] = "'(hidden)'";  
                break;  
              }  
            }  
          }  
        }  
        // reconstruct the query  
        $query = 'INSERT INTO '.$matches[1].' ('.join(',', $fields).') VALUES ('.join(',', $values).')';  
      }  
    }  
  }  
  return $query;  
}  
  
  
```  
